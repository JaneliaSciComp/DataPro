//	DataPro Analysis//	Adapted from BAD_ASS//	(Browse, Analyze Data, and Average Selected Sweeps, Nelson Spruston, 8/95)//	DataPro Analyze began 8/24/99//	last updated 7/23/02#pragma rtGlobals=1		// Use modern global access method.//________________________DataPro Analyze ______________________//Function AnalyzeButtonProc(ctrlName) : ButtonControl	String ctrlName	Execute "Analysis()"EndFunction GoToSweep(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	NextSweep()EndFunction GoToSweepName(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	String savDF=GetDataFolder(1)	SetDataFolder root:DP_Browser	NVAR oldbname1=oldbname1, bname1=bname1	NVAR oldbname2=oldbname2, bname2=bname2	NextSweep()	oldbname1=bname1	oldbname2=bname2	SetDataFolder savDFEndFunction NextSweep()//	print "next sweep"	Variable browser_number	String errmsg, doit, savDF, wavesongraph	String browser_name, browser_folder	savDF=GetDataFolder(1)	browser_number=GetBrowserNumber()	sprintf browser_name "DataProBrowser_%d", browser_number	sprintf browser_folder "root:DP_Browser_%d", browser_number	if (browser_number<1)		browser_name="DataProBrowser"		browser_folder="root:DP_Browser"	endif	SetDataFolder browser_folder	NVAR newSweep=newSweep, oldSweep=oldSweep, clamp_mode=root:DP_ADCDACcontrol:clamp_mode	NVAR red=red, green=green, blue=blue	SVAR bname1=bname1, bname2=bname2, topwave=topwave	SVAR newWave1=newWave1, newWave2=newWave2, oldbname1=oldbname1, oldbname2=oldbname2	WAVE Colors=root:DP_Browser:Colors	PauseUpdate; Silent 1	GetAxesLimits()	sprintf newWave1 "root:%s%d", bname1, newSweep	sprintf newWave2 "root:%s%d", bname2, newSweep	RemoveBaseNamedWaves(bname1)	RemoveBaseNamedWaves(oldbname1)	RemoveBaseNamedWaves(bname2)	RemoveBaseNamedWaves(oldbname2)	RemoveBaseNamedWaves("showfit")	SetDataFolder root:	ControlInfo /W=DP_Browser show1	if (V_value>0)		if (exists(newWave1)!=1)//			Checkbox show1 value=0			sprintf errmsg, "Wave %s does not exist.", newWave1//			newSweep=oldSweep//			Abort errmsg			print errmsg		endif	endif	ControlInfo /W=DP_Browser show2	if (V_value>0)		if (exists(newWave2)!=1)//			Checkbox show2 value=0			sprintf errmsg, "Wave %s does not exist.", newWave1//			newSweep=oldSweep//			Abort errmsg			print errmsg		endif	endif	if (exists(newWave1)>0 || exists(newWave2)>0)		DoBaseSub()	endif	ControlInfo /W=DataProBrowser show2	if ((V_value>0) %& (exists(newWave2)==1))		AppendToGraph $newWave2		red=Colors[1][0]		green=Colors[1][1]		blue=Colors[1][2]		GraphColors(bname2,newSweep,red,green,blue)		topwave=newWave2	endif	ControlInfo /W=DataProBrowser show1	if ((V_value>0) %& (exists(newWave1)==1))		AppendToGraph $newWave1		red=Colors[0][0]		green=Colors[0][1]		blue=Colors[0][2]		GraphColors(bname1,newSweep,red,green,blue)		topwave=newWave1	endif//	PlaceCursors(topwave)	UpdateRejectBox()//	Show Comments	GetComments()	wavesongraph=TraceNameList("",";",1)//	print wavesongraph, strlen(wavesongraph)	if (strlen(wavesongraph)>1)		RescaleAxes()		ModifyGraph grid(left)=1	endif	Label bottom "\\F'Helvetica'\\Z12\\f01milliseconds"	if (clamp_mode<1)		Label left "\\F'Helvetica'\\Z12\\f01picoAmperes"	else		Label left "\\F'Helvetica'\\Z12\\f01millivolts"	endif	if (exists(newWave1)>0)//		UpdateValues()	endif	oldSweep=newSweep	SetDataFolder savDFEndFunction GetBrowserNumber()	String topwin, key, doit	Variable browser_number	topwin=WinName(0,1)	if (cmpstr(topwin,"DataProBrowser")==0)		browser_number=0	else		key=StringByKey("DataProBrowser", topwin,"_")		browser_number=str2num(key)	endif	return browser_numberEndFunction AppRemSweep(ctrlName,swapprem) : CheckBoxControl	String ctrlName	Variable swapprem	String doit	NextSweep()EndFunction RemoveBaseNamedWaves(base)	String base	String savDF, window, allwaves, thiswave	Variable i	savDF=GetDataFolder(1)	SetDataFolder root:	base+="*"	sprintf window, "WIN:"	allwaves=WaveList(base,";", window)	if (strlen(allwaves)>0)		i=0		do			thiswave=GetStrFromList(allwaves,i,";")			if (strlen(thiswave)==0)				break			else				RemoveFromGraph $thiswave			endif			i+=1		while(1)	endif	SetDataFolder savDFEndFunction UpdateRejectBox()	String savDF=GetDataFolder(1)	String browser_name, browser_folder	Variable browser_number=GetBrowserNumber()	sprintf browser_name "DataProBrowser_%d", browser_number	sprintf browser_folder "root:DP_Browser_%d", browser_number	if (browser_number<1)		browser_name="DataProBrowser"		browser_folder="root:DP_Browser"	endif	SetDataFolder browser_folder	SVAR newWave1=newWave1	SVAR newWave2=newWave2	WAVE Wave1=$newWave1	WAVE Wave2=$newWave2	ControlInfo show1	if ((V_value>0) %& (exists(newWave1)==1))		CheckBox reject1, value=GetWaveNoteNumber(Wave1,"REJECT")	endif	ControlInfo show2	if ((V_value>0) %& (exists(newWave2)==1))		CheckBox reject2, value=GetWaveNoteNumber(Wave2,"REJECT")	endif	SetDataFolder savDFEndFunction GetComments()	String savDF=GetDataFolder(1)	String browser_name, browser_folder	Variable browser_number=GetBrowserNumber()	sprintf browser_name "DataProBrowser_%d", browser_number	sprintf browser_folder "root:DP_Browser_%d", browser_number	if (browser_number<1)		browser_name="DataProBrowser"		browser_folder="root:DP_Browser"	endif	SetDataFolder browser_folder	SVAR comments=comments	SVAR newWave1=newWave1	SVAR newWave2=newWave2	WAVE Wave1=$newWave1	WAVE Wave2=$newWave2	ControlInfo show1	if ((V_value>0) %& (exists(newWave1)==1))		comments=GetWaveNoteString(Wave1,"COMMENTS")	else		ControlInfo show2		if ((V_value>0) %& (exists(newWave2)==1))			comments=GetWaveNoteString(Wave2,"COMMENTS")		endif	endif	SetDataFolder savDFEndFunction RejectAccept(ctrlName,rejcheck) : CheckBoxControl	String ctrlName	Variable rejcheck	String browser_name, browser_folder, savDF	Variable browser_number	savDF=GetDataFolder(1)	browser_number=GetBrowserNumber()	sprintf browser_name "DataProBrowser_%d", browser_number	sprintf browser_folder "root:DP_Browser_%d", browser_number	if (browser_number<1)		browser_name="DataProBrowser"		browser_folder="root:DP_Browser"	endif	SetDataFolder browser_folder	if (cmpstr(ctrlName,"reject1")==0)		SVAR wavename=newWave1	else		SVAR wavename=newWave2	endif	SetDataFolder root:	WriteWaveNote($wavename,"REJECT",num2str(rejcheck)+"\r")	SetDataFolder savDFEndFunction BaseSub(ctrlName,bsubcheck) : CheckBoxControl	String ctrlName	Variable bsubcheck	DoBaseSub()	RescaleAxes()//	UpdateValues()EndFunction DoBaseSub()	Variable browser_number	String errmsg, doit, savDF	String browser_name, browser_folder	savDF=GetDataFolder(1)	browser_number=GetBrowserNumber()	sprintf browser_name "DataProBrowser_%d", browser_number	sprintf browser_folder "root:DP_Browser_%d", browser_number	if (browser_number<1)		browser_name="DataProBrowser"		browser_folder="root:DP_Browser"	endif	SetDataFolder browser_folder	NVAR newSweep=newSweep	SVAR newWave1=newWave1, newWave2=newWave2, bname1=bname1, bname2=bname2	sprintf newWave1 "root:%s%d", bname1, newSweep	sprintf newWave2 "root:%s%d", bname2, newSweep	WAVE theWave=$newWave1	Variable basesubtracted, baseline	ControlInfo show1	if ((V_value>0) %& (exists(newWave1)==1))		baseline=GetWaveNoteNumber(theWave,"BASELINE")		basesubtracted=GetWaveNoteNumber(theWave,"BASESUBTRACTED")//		print baseline, basesubtracted	endif	ControlInfo basesub1	if ((V_value>0) %& (exists(newWave2)==1))			// if baseline subtract is checked		 if (basesubtracted<1)							// but the baseline isn't subtracted			theWave -=  baseline							// subtract baseline			WriteWaveNote($newWave1,"BASESUBTRACTED","1")	// and note baseline subtracted		endif	else												// if baseline subtract is not checked		 if (basesubtracted>0)							// but the baseline is subtracted			theWave +=  baseline							// add back the baseline			WriteWaveNote($newWave1,"BASESUBTRACTED","0")	// and note baseline not subtracted		endif	endif	ControlInfo show2	if ((V_value>0) %& (exists(newWave2)==1))		WAVE theWave=$newWave2		baseline=GetWaveNoteNumber(theWave,"BASELINE")		basesubtracted=GetWaveNoteNumber(theWave,"BASESUBTRACTED")	endif	ControlInfo basesub2	if ((V_value>0) %& (exists(newWave2)==1))				// if baseline subtract is checked		 if (basesubtracted<1)							// but the baseline isn't subtracted			theWave -=  baseline							// subtract baseline			WriteWaveNote(theWave,"BASESUBTRACTED","1")	// and note baseline subtracted		endif	else												// if baseline subtract is not checked		 if (basesubtracted>0)							// but the baseline is subtracted			theWave +=  baseline							// add back the baseline			WriteWaveNote(theWave,"BASESUBTRACTED","0")	// and note baseline not subtracted		endif	endif	SetDataFolder savDFEndFunction GraphColors(thename, sweep, rval, gval, bval)	String thename	Variable sweep, rval, gval, bval	String thewave	sprintf thewave "%s%d", thename, sweep	ModifyGraph rgb($thewave)=(rval,gval,bval)	ModifyGraph grid(left)=1EndFunction Analyze(ctrlName) : ButtonControl	String ctrlName	PauseUpdate; Silent 1		// building window...	String createpanel	createpanel="MeasurePanel()"	UpdateValues()	if (wintype("MeasurePanel")!=7)		Execute createpanel	else		DoWindow /F MeasurePanel	endif	DoWindow /F DataProBrowserEndFunction AverageSweeps(ctrlName) : ButtonControl	String ctrlName	PauseUpdate; Silent 1		// building window...	String createpanel	createpanel="AveragePanel()"	if (wintype("AveragePanel")!=7)		Execute createpanel	else		DoWindow /F AveragePanel	endif	DoWindow /F DataBrowserEndFunction Fit(ctrlName) : ButtonControl	String ctrlName	PauseUpdate; Silent 1		// building window...	String createpanel	createpanel="FitPanel()"	if (wintype("FitPanel")!=7)		Execute createpanel	else		DoWindow /F FitPanel	endif	DoWindow /F DataBrowserEndFunction UpdateValues()	String savDF, browser_name, browser_folder	Variable browser_number	savDF=GetDataFolder(1)	browser_number=GetBrowserNumber()	sprintf browser_name "DataProBrowser_%d", browser_number	sprintf browser_folder "root:DP_Browser_%d", browser_number	if (browser_number<1)		browser_name="DataProBrowser"		browser_folder="root:DP_Browser"	endif	SetDataFolder browser_folder	NVAR hold1=hold1, step1=step1, hold2=hold2, step2=step2	NVAR mean_left=mean_left, mean_right=mean_right	NVAR win1_left=win1_left, win1_right=win1_right, win2_left=win2_left, win2_right=win2_right	SVAR newWave1=newWave1, newWave2=newWave2, topwave=topwave, comments=comments	Variable /G base, mean1, peak1, rise1	Variable /G mean2, peak2, rise2	ControlInfo show1	if (V_value>0)		hold1=GetWaveNoteNumber($newWave1,"BASELINE")//		print hold1		step1=GetWaveNoteNumber($newWave1,"STEP")		comments=GetWaveNoteString($newWave1,"COMMENTS")	endif	ControlInfo show2	if (V_value>0)		hold2=GetWaveNoteNumber($newWave2,"BASELINE")		step2=GetWaveNoteNumber($newWave2,"STEP")	endif	if (exists("mlineleft")==1)		if ((mean_left<leftx($CsrWave(A))) %| (mean_right>rightx($CsrWave(A))))			RemoveBaseNamedWaves("mline")		endif		base=mean($newWave1,mean_left,mean_right)	else		base=0	endif	if (exists("w1lineleft")==1)		if ((win1_left<leftx($CsrWave(A))) %| (win1_right>rightx($CsrWave(A))))			RemoveBaseNamedWaves("w1line")		endif		WaveStats /Q/R=(win1_left,win1_right) $CsrWave(A)		mean1=V_avg-base		if (abs(V_min-base)>abs(V_max-base))			peak1=V_min-base		else			peak1=V_max-base			endif		FindRise(1)		FindTheLevels(1)	else		mean1=0		peak1=0		rise1=0	endif	if (exists("w2lineleft")==1)		if ((win2_left<leftx($topwave)) %| (win2_right>rightx($topwave)))			RemoveBaseNamedWaves("w2line")		endif		WaveStats /Q/R=(win2_left,win2_right) $CsrWave(A)		mean2=V_avg-base		if (abs(V_min-base)>abs(V_max-base))			peak2=V_min-base		else			peak2=V_max-base				endif		FindRise(2)	else		mean2=0		peak2=0		rise2=0	endif	SetDataFolder savDFEndFunction SetBaseline(ctrlName) : ButtonControl	String ctrlName	String alreadythere	Variable /G mean_left, mean_right	mean_left=xcsr(A)	mean_right=xcsr(B)	Make /O/N=2 mlineleft, mlineright	mlineleft[0]=-1e6 // v_bottom	mlineleft[1]=1e6 // v_top	Setscale /I x, mean_left, mean_left+0.1, "mV", mlineleft	mlineright[0]=-1e6 // v_bottom	mlineright[1]=1e6 // v_top	Setscale /I x, mean_right, mean_right+0.1, "ms", mlineright	alreadythere=WaveList("mlineleft",";","WIN:DataBrowser")	if (CmpStr(alreadythere,"")!=0)		RemoveFromGraph mlineleft, mlineright	endif	AppendtoGraph mlineleft, mlineright	UpdateValues()EndFunction SetWin(ctrlName) : ButtonControl	String ctrlName	if (cmpstr(ctrlName[7],"1")==0)		SetTheWin(1)	else		SetTheWin(2)	endifEndFunction SetTheWin(n)	Variable n	if (n==1)		Variable /G win1_left, win1_right		Make /O/N=2 w1lineleft, w1lineright		NVAR left=win1_left, right=win1_right		WAVE lineleft=w1lineleft, lineright=w1lineright	else		Variable /G win2_left, win2_right		Make /O/N=2 w2lineleft, w2lineright		NVAR left=win2_left, right=win2_right		WAVE lineleft=w2lineleft, lineright=w2lineright	endif	String alreadythere	left=xcsr(A)	right=xcsr(B)	lineleft[0]=-1e6	lineleft[1]=1e6	Setscale /I x, left, left+0.1, "ms", lineleft	lineright[0]=-1e6	lineright[1]=1e6	Setscale /I x, right, right+0.1, "ms", lineright	if (n==1)		alreadythere=WaveList("w1lineleft",";","WIN:DataBrowser")		if (CmpStr(alreadythere,"")!=0)			RemoveFromGraph w1lineleft, w1lineright		endif		AppendtoGraph lineleft, lineright		ModifyGraph rgb(w1lineleft)=(3,52428,1)		ModifyGraph rgb(w1lineright)=(3,52428,1)	else		alreadythere=WaveList("w2lineleft",";","WIN:DataBrowser")		if (CmpStr(alreadythere,"")!=0)			RemoveFromGraph w2lineleft, w2lineright		endif		AppendtoGraph lineleft, lineright		ModifyGraph rgb(w2lineleft)=(0,0,65535)		ModifyGraph rgb(w2lineright)=(0,0,65535)	endif	UpdateValues()EndFunction UpdateRise(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	if ( (cmpstr(varName,"from1")==0) %| (cmpstr(varName,"to1")==0))		FindRise(1)	else		FindRise(2)	endifEndFunction FindRise(n)	Variable n	Variable first, second	if (n==1)		NVAR left=win1_left, right=win1_right, base=base		NVAR peak=peak1, from=from1, to=to1, rise=rise1	endif	if (n==2)		NVAR left=win2_left, right=win2_right, base=base		NVAR peak=peak2, from=from2, to=to2, rise=rise2	endif	SVAR topwave=topwave	WAVE theWave=$topwave	FindLevel /Q/R=(left,right) thewave, base+from*peak/100	if (V_Flag<1)		first=V_LevelX	else		first=NaN	endif	FindLevel /Q/R=(first,right) thewave, base+to*peak/100	if (V_Flag<1)		second=V_LevelX	else		second=NaN	endif	rise=round((second-first)*100)/100EndFunction UpdateLevels(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	FindTheLevels(1)EndFunction FindTheLevels(n)	Variable n	if (n==1)		NVAR left=win1_left, right=win1_right, lev=lev1, cross=cross1	else		NVAR left=win2_left, right=win2_right, lev=lev2, cross=cross2	endif	SVAR topwave=topwave	WAVE thewave=$topwave	FindLevels /Q/R=(left,right) thewave, lev	cross=V_LevelsFoundEndFunction AverageSelectedSweeps(ctrlName) : ButtonControl	String ctrlName	DoAverage()EndFunction DoAverage()	PauseUpdate; Silent 1	String savDF=GetDataFolder(1)	SetDataFolder root:DP_Analysis	Variable from, to, i, avgflag1, avgflag2, dontavg1, dontavg2, reject1, reject2	String wave1, wave2, wt1, wt2	Variable ch1, ch2	NVAR firstwave=firstwave, lastwave=lastwave, avgto=avgto, avgfrom=avgfrom	NVAR hold1=hold1, hold2=hold2, step1=step1, step2=step2, avghold=avghold	NVAR holdtolerance=holdtolerance, avgstep=avgstep	SVAR bname1=root:DP_Browser:bname1, bname2=root:DP_Browser:bname2	ControlInfo /W=AveragePanel range_all	if (V_value>0)		from=firstwave		to=lastwave	else		from=avgfrom		to=avgto	endif	i=from	Controlinfo /W=DataProBrowser show1	if (V_value>0)		ch1=1	endif	Controlinfo /W=DataProBrowser show2	if (V_value>0)		ch2=1	endif	DoWindow /F AveragePanel	SetDataFolder root:	i=from	do		dontavg1=0; dontavg2=0		sprintf wave1, "%s%d", bname1, i		sprintf wave2, "%s%d", bname2, i		if (ch1>0)			wt1=GetWaveNoteString($wave1, "WAVETYPE")			if (cmpstr(wt1,"average")==0)				avgflag1=1				dontavg1 += 1			endif			reject1=GetWaveNoteNumber($wave1, "REJECT")			if (reject1>0)				dontavg1 += 10			endif		endif		if (ch2>0)			wt2=GetWaveNoteString($wave2, "WAVETYPE")			if (cmpstr(wt2,"average")==0)				avgflag2=1				dontavg2 += 1			endif			reject2=GetWaveNoteNumber($wave2, "REJECT")			if (reject2>0)				dontavg2 += 10			endif		endif		ControlInfo /W=AveragePanel hold_all		if (V_value<1)			if (ch1>0)				hold1=GetWaveNoteNumber($wave1, "BASELINE")				if ( (hold1<avghold-holdtolerance) %| (hold1>avghold+holdtolerance) )					dontavg1 += 100				endif			endif			if (ch2>0)				hold2=GetWaveNoteNumber($wave2, "BASELINE")				if ( (hold2<avghold-holdtolerance) %| (hold2>avghold+holdtolerance) )					dontavg2 += 100				endif			endif		endif		ControlInfo /W=AveragePanel step_all		if (V_value<1)			if (ch1>0)				step1=GetWaveNoteNumber($wave1, "STEP")				if (abs(step1-avgstep)>0.1)					dontavg1 += 1000				endif			endif			if (ch2>0)				step2=GetWaveNoteNumber($wave2, "STEP")				if (abs(step2-avgstep)>0.001)					dontavg2 += 1000				endif			endif		endif		if (ch1>0)			WriteWaveNote($wave1,"DONTAVG",num2str(dontavg1))		endif		if (ch2>0)			WriteWaveNote($wave2,"DONTAVG",num2str(dontavg2))		endif		i+=1	while(i<to+1)	if (ch1>0)		AvgLoop(1,bname1)	endif	if (ch2>0)		AvgLoop(2,bname2)	endif	SetDataFolder savDFEndFunction AvgLoop(channel, wavebase)	Variable channel	String wavebase	String savDF=GetDataFolder(1)	SetDataFolder root:DP_Analysis	String nextwavestr, savedest, avgmessage	Variable dontavg, index, i, to, from	NVAR avgto=avgto, avgfrom=avgfrom, avgstep=avgstep//	SVAR destwave=root:destwave	String destwave	SVAR base1=root:DP_Browser:bname1, base2=root:DP_Browser:bname2	NVAR wavenumber=root:DP_ADCDACcontrol:wavenumber	SetDataFolder root:DP_ADCDACcontrol	if (channel<2)		sprintf destwave "%s%d", base1, wavenumber	else		sprintf destwave "%s%d", base2, wavenumber	endif	wavenumber+=1	SetDataFolder root:	to=avgto	from=avgfrom	index=0	i=from	do		sprintf nextwavestr "%s%d", wavebase, i		WAVE nextwave=$nextwavestr		dontavg=GetWaveNoteNumber(nextwave,"DONTAVG")		if (dontavg<1)			if (index<1)				Duplicate /O nextwave root:$destwave				WAVE outwave=root:$destwave				Note /K outwave				WriteWaveNote(outwave,"WAVETYPE","average")				WriteWaveNote(outwave,"TIME",time())				WriteWaveNote(outwave,"DONTAVG","1")				WriteWaveNote(outwave,"STEP",num2str(avgstep)+"\r")				outwave = 0			endif			outwave += nextwave			index += 1		endif		i+=1	while(i<to+1)	if (index>0)		outwave /= index	else		sprintf avgmessage, "Ch.%d: No waves met your criteria to be averaged.", channel		SetDataFolder savDF		Abort avgmessage	endif	sprintf avgmessage "Ch.%d: %d waves were averaged and stored in %s", channel, index, destwave	print avgmessage	ControlInfo saveavg		if (V_value>0)		sprintf savedest "%s.avg", destwave		Save/C/I outwave as savedest		sprintf avgmessage "Ch.%d: Average saved to disk as %s", channel, savedest	else		sprintf avgmessage "Ch.%d: Average not saved to disk", channel	endif	print avgmessage	SetDataFolder savDFEnd//Proc AvgOutName(outwave, avgprompt)//	String outwave, avgprompt//	Prompt outwave, avgprompt//	destwave=outwave//EndFunction SetFitZero(ctrlName) : ButtonControl	String ctrlName	String alreadythere	Variable /G fit_zero	fit_zero=xcsr(A)	Make /O/N=2 fzline	fzline[0]=-120	fzline[1]=120	Setscale /I x, fit_zero, fit_zero+0.1, "ms", fzline	alreadythere=WaveList("fzline",";","WIN:DataBrowser")	if (CmpStr(alreadythere,"")!=0)		RemoveFromGraph fzline	endif	AppendtoGraph fzline	ModifyGraph rgb(fzline)=(26411,1,52428)EndFunction SetFitRange(ctrlName) : ButtonControl	String ctrlName	String alreadythere	Variable /G fit_zero, fit_left, fit_right	fit_left=xcsr(A)	fit_right=xcsr(B)	Make /O/N=2 fitlineleft, fitlineright	fitlineleft[0]=-120	fitlineleft[1]=120	Setscale /I x, fit_left, fit_left+0.1, "ms", fitlineleft	fitlineright[0]=-120	fitlineright[1]=120	Setscale /I x, fit_right, fit_right+0.1, "ms", fitlineright	alreadythere=WaveList("fitlineleft",";","WIN:DataBrowser")	if (CmpStr(alreadythere,"")!=0)		RemoveFromGraph fitlineleft, fitlineright	endif	AppendtoGraph fitlineleft, fitlineright	ModifyGraph rgb(fitlineleft)=(0,65535,65535)	ModifyGraph rgb(fitlineright)=(0,65535,65535)EndFunction ExponentialFit(ctrlName) : ButtonControl	String ctrlName	Execute "DoFit()"EndFunction DoFit()	SVAR newWave1=newWave1	NVAR fit_zero=fit_zero, fitbase=fitbase, amp1=amp1, tau1=tau1, amp2=amp2, tau2=tau2	NVAR fit_right=fit_right, fitextend=fitextend	WAVE W_coef=W_coef	PauseUpdate; Silent 1		// building window...	Variable left, right, hold	String S_value, FitCommand, fitthere	Duplicate /O $newWave1 fitwave	left=leftx($newWave1)-fit_zero	right=pnt2x($newWave1,numpnts($newWave1)-1)-fit_zero	Setscale /I x, left,right, "ms", fitwave	FitCommand="CurveFit "	ControlInfo fitbase_check	if (V_value<1)		hold=0	else			hold=1	endif	ControlInfo fit_function	if (cmpstr(S_value,"single exp")==0)		if (hold>0)			FitCommand+="/H=\"100\" "		endif		FitCommand+="exp, "	else		if (hold>0)			FitCommand+="/H=\"10000\" "		endif		FitCommand+="dblexp, "	endif	FitCommand+="fitwave(fit_left-fit_zero,fit_right-fit_zero)"	Execute FitCommand	fitbase=W_coef[0]	amp1=W_coef[1]	tau1=1/W_coef[2]	amp2=W_coef[3]	tau2=1/W_coef[4]	if (cmpstr(S_value,"single exp")==0)		amp2=0		tau2=0	endif	Make /O/N=500 showfit	Setscale /I x, 0, fit_right+fitextend-fit_zero, "ms", showfit	showfit= fitbase+amp1*exp(-x/tau1)+amp2*exp(-x/tau2)	Setscale /I x, fit_zero, fit_right+fitextend, "ms", showfit	DoWindow /F DataBrowser	fitthere=WaveList("showfit",";","WIN:DataBrowser")	if (CmpStr(fitthere,"")==0)		AppendtoGraph showfit	endifEndProc DataBrowser_Help()	String AbortMessage	AbortMessage="To get help, open the 'DataBrowser_Help' file (as a help file) or "	AbortMessage+= "double click on the icon in the finder.  After doing so, 'DataBrowser_Help' "	AbortMessage+= "will appear under 'Help Windows' in the Igor 'Windows' pulldown"	Abort AbortMessageEnd//-------------------------USEFUL ANALYSIS UTILITIES-------------------------//Proc SetDataUnits(match,units)	String match, units	String list, command	list=Wavelist(match,",","")	sprintf command "SetScale d 0,0,\"%s\" %s", units, list	print command	Execute commandEndProc GetRidofGraphAxes()	ModifyGraph noLabel=2,axThick=0EndProc DisplaySeries(name,first,n,left,top,right,bottom)	String name, wave	Variable first=0, n=1, left=0, top=0, right=700, bottom=500	iterate(n)		sprintf wave "%s%d", name, first+i		if (i==0)			Display /W=(left,top,right,bottom) $wave			PauseUpdate		else			Append $wave		endif	loop	Modify rgb=(0,0,0)	Modify axThick=0	Modify noLabel=2	Modify lsize=0.7EndProc KillWindows()	Silent 1	String name, list	String win	Variable index=0	list = Winlist("*",";","WIN:7")	do		| get the next window		win = GetStrFromList(list, index, ";")		if (strlen(win) == 0)			break		else			DoWindow /K $win		endif		index += 1	while (1) | loop until break aboveEndProc KillWavesWithName(name)	String name, list, match	Silent 1	String wave	Variable index=0	sprintf match "%s*", name	list = Wavelist(match,";","")	do		| get the next wave		wave = GetStrFromList(list, index, ";")		if (strlen(wave) == 0)			break		else			KillWaves $wave		endif		index += 1	while (1) | loop until break aboveEndFunction Inflection(wave,level,left,right)//	Finds inflection point of a wave	String wave	Variable level, left, right	String diff	sprintf diff, "diff_%s", wave[0]	Duplicate /O $wave $diff	Smooth/S=4/E=3 7, $diff	Differentiate $diff	FindLevel /Q/R=(left,right) $diff, level	return V_LevelXEndFunction niceround(x)	Variable x	do		if (x<5)			x=round(x)			break		endif		if (x<10)			x=round(x/5)*5			break		endif		if (x<50)			x=round(x/10)*10			break		endif		if (x<100)			x=round(x/25)*25			break		endif		if (x<250)			x=round(x/50)*50			break		else			x=round(x/100)*100		endif	while(0)	return xEnd//-----------------------Calibrator from Wavemetrics------------------------//Function InitCalibratorGlobals()	String/G u_xaxis="bottom",u_yaxis="left"	Variable/G/D u_dx=1,u_dy=1	Variable/G u_orient=3,u_label=3	// lower-left, print with unitsEndProc Calibrator()	if (exists("u_xaxis")<2)		InitCalibratorGlobals()	endif	WMCalibrator()EndProc WMCalibrator(xaxis,yaxis,dx,dy,orient,label)	String xaxis=u_xaxis, yaxis=u_yaxis	Variable/D dx=u_dx,dy=u_dy	Variable orient=u_orient,label=u_label	Prompt xaxis,"X axis (horizontal axis)",popup,HVAxisList("",1)	//  only horizontal axes	Prompt yaxis,"Y axis (vertical axis)",popup,HVAxisList("",0)	//  only vertical axes	Prompt dx,"calibrator X length, or 0 for none"	Prompt dy,"calibrator Y length, or 0 for none"	Prompt orient,"Orientation",popup,"upper-left;upper-right;lower-right;lower left;"	Prompt label,"print values",popup,"donÕt print;print;print with units;print with units and ,K,m,µ etc"		PauseUpdate;Silent 1	u_xaxis=xaxis;u_yaxis=yaxis	u_dx=dx;u_dy=dy	u_orient=orient;u_label=label		FCalibrator(xaxis,yaxis,dx,dy,orient,label)End// Replace "Function" with "Macro" to reduce compile timeFunction FCalibrator(xaxis,yaxis,dx,dy,orient,label)	String xaxis,yaxis	Variable/D dx,dy	Variable orient,label	// see popup list of Calibrator macro for label values (1 is don't print, etc)		// Put calibrator in upper right corner of graph	Variable/D xorig,yorig	// corner of calibrator	Variable/D px,py		// polygon origin	Variable/D hx,hy,vx,vy	// text origins	Variable/D sf=0.15		// inset from upper-right corner	GetAxis/Q $xaxis;xorig=V_max-(V_max-V_min)*sf	GetAxis/Q $yaxis;yorig=V_max-(V_max-V_min)*sf	GraphNormal			// Forces deselection	SetDrawEnv gstart		// gstart can't be on next line!	SetDrawEnv xcoord= $xaxis,ycoord= $yaxis, fillpat=0,linethick=2, linefgc=(0,0,0)	if(orient == 1) // upper-left		xorig -= dx		hx= xorig + dx/2		vy= yorig - dy/2		px= xorig;py=yorig-dy		DrawPoly px,py, 1, 1, {0,0,0,dy,dx,dy}	endif	if(orient == 2) // upper-right		hx= xorig - dx/2		vy= yorig - dy/2		px= xorig-dx;py=yorig		DrawPoly px,py, 1, 1, {0,0,dx,0,dx,-dy}	endif	if(orient == 3) // lower-right		yorig -= dy		hx= xorig - dx/2		vy= yorig + dy/2		px= xorig;py=yorig+dy		DrawPoly px,py, 1, 1, {0,0,0,-dy,-dx,-dy}	endif	if(orient == 4) // lower left		xorig -= dx		yorig -= dy		hx= xorig + dx/2		vy= yorig + dy/2		px= xorig+dx;py=yorig		DrawPoly px,py, 1, 1, {0,0,-dx,0,-dx,dy}	endif	String labelVal,fmt,units	// horizontal calibrator value	if( (dx != 0)%& (label>1) )		// label == 1 is don't print		units= AxisUnits(xaxis)		fmt="%g"		if( (label== 3) %& (strlen(units)>0) )	// 3 is print with units			fmt += " "+units		endif		if(label == 4)				// 4 is print with units and prefixes			fmt="%.1W1P"+units	// change %.1 to number of digits after decimal point you want (%.2 is two digits, etc)		endif		sprintf labelVal, fmt, dx		hy = yorig-(0.1*dy)		Variable yj=0	// bottom		if( orient >= 3 )			yj= 2		// top		endif		SetDrawEnv xcoord= $xaxis,ycoord= $yaxis,textxjust=1,textyjust=yj		DrawText hx,hy, labelVal	endif	// vertical calibrator value	if( (dy != 0)%& (label>1) )		units= AxisUnits(yaxis)		fmt="%g"		if( (label== 3) %& (strlen(units)>0) )			fmt += " "+units		endif		if(label == 4)			fmt="%.1W1P"+units		endif		sprintf labelVal, fmt, dy		vx= xorig+(0.1*dx)		Variable xj=0,rot=0					// left	| use rot= -90 for top-to-bottom		if( (orient == 1) %| (orient == 4) )	// "upper-left; upper-right;lower-right;lower left;"			xj= 0								// right use rot=90 for bottom-to-top		endif		SetDrawEnv xcoord= $xaxis,ycoord= $yaxis,textxjust= xj,textyjust=1,textrot=rot		DrawText vx,vy, " "+labelVal+" "	// extra spaces to keep label away from line	endif	SetDrawEnv gstopEndFunction CountItemsInList(theList)        String theList        Variable i=0        do                if (strlen(GetStrFromList(theList, i, ";")) == 0)                        break                endif                i += 1        while(1)        return iendFunction CountWaves(BaseStr)       String BaseStr 	return CountItemsInList(GetSweepList(BaseStr))endFunction /S GetSweepList(BaseStr)	String BaseStr	String SweepList	String firstList, item, back       Variable xx, i	firstList = WaveList(BaseStr+"*", ";","")//	removes all items from the list that do not have the form BaseStr+number      SweepList = ""      i =0      	do       	item = GetStrFromList(firstList, i, ";")		if (strlen(item) == 0)                        break              else			xx = str2num(item[strlen(BaseStr),99])			back = BaseStr+num2str(xx)			if (abs(cmpstr(item,back))<1)				SweepList += item+";"			endif		endif		i += 1	while(1)	return SweepListEndFunction SetStepVarProc(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	String command	NVAR newSweep=newSweep	sprintf command, "SetStepValue(\"%s\",%d,%d)", varName, newSweep, varNum	Execute commandEndProc SetStepValue(whichstep, whichsweep, stepval)	String whichstep	Variable whichsweep, stepval	String wavestr	if (cmpstr(whichstep,"step1")<1)		sprintf wavestr, "%s%d", bname1, whichsweep		WriteWaveNote($wavestr,"STEP",num2str(stepval))	endif	if (cmpstr(whichstep,"step2")<1)		sprintf wavestr, "%s%d", bname2, whichsweep		WriteWaveNote($wavestr,"STEP",num2str(stepval))	endif	if (cmpstr(whichstep,"step3")<1)		sprintf wavestr, "%s%d", bname1, whichsweep		WriteWaveNote($wavestr,"STEP",num2str(stepval))		sprintf wavestr, "%s%d", bname2, whichsweep		WriteWaveNote($wavestr,"STEP",num2str(stepval))	endifEnd