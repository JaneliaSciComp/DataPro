//	DataPro//	DAC/ADC macros for use with Igor Pro and the ITC-16 or ITC-18//	Nelson Spruston//	Northwestern University//	project began 10/27/1998Function NewTestPulseWindow() : Graph	// Save the data folder	String savedDF=GetDataFolder(1)		// If the data folder doesn't exist, create it	if (!DataFolderExists("root:DP_TestPulse")) 		NewDataFolder /S root:DP_TestPulse		Variable /G amplitude=1		// test pulse amplitude, units determined by channel type		Variable /G duration=10		// test pulse duration, ms		Variable /G dt=0.02		// sample interval for the test pulse, ms		Variable /G adcIndex=0		// index of the ADC channel to be used for the test pulse		Variable /G dacIndex=0		// index of the DAC channel to be used for the test pulse			Variable /G ttlOutput=0		// whether or not to do a TTL output during test pulse		Variable /G ttlOutIndex=0	   // index of the TTL used for gate output, if ttlOutput is true		Variable /G doBaselineSubtraction=1	// whether to do baseline subtraction		Variable /G RSeal=nan	// GOhm		Variable /G updateRate=nan		// Hz		endif		// Set the data folder	SetDataFolder root:DP_TestPulse		// Declare instance variables	NVAR ttlOutput	NVAR doBaselineSubtraction		NVAR RSeal	NVAR updateRate		// Kill any pre-existing window		if (GraphExists("TestPulseWindow"))		DoWindow /K TestPulseWindow	endif		// Create the graph window	// These are all in pixels	Variable xOffset=1060	Variable yOffset=54	Variable width=300*ScreenResolution/72	Variable height=300*ScreenResolution/72	// Convert dimensions to points	Variable pointsPerPixel=72/ScreenResolution	Variable xOffsetInPoints=pointsPerPixel*xOffset	Variable yOffsetInPoints=pointsPerPixel*yOffset	Variable widthInPoints=pointsPerPixel*width	Variable heightInPoints=pointsPerPixel*height	Display /W=(xOffsetInPoints,yOffsetInPoints,xOffsetInPoints+widthInPoints,yOffsetInPoints+heightInPoints) /N=TestPulseWindow /K=1 as "Test Pulse"		// If TestPulse_ADC exists, put it in the graph window	if (WaveExists(TestPulse_ADC))		AppendToGraph /W=TestPulseWindow TestPulse_ADC		ModifyGraph grid(left)=1		ModifyGraph tickUnit(bottom)=1		MatchYAxisLimitsToTrace()		SyncAxisLabelsToModel()	endif		// Draw the top "panel"	ControlBar /T /W=TestPulseWindow 80	// Control widgets for the test pulse		Button startButton,pos={18,10},size={80,20},proc=TPStartButtonProc,title="Start"	TitleBox proTipTitleBox,pos={10,30+4},frame=0,title="(hit ESC key to stop)",disable=1	SetVariable test_dac,pos={110+30,10},size={70,1},title="DAC #"	SetVariable test_dac,limits={0,3,1},value= root:DP_TestPulse:dacIndex	SetVariable test_adc,pos={110+30,30},size={70,1},title="ADC #"	SetVariable test_adc,limits={0,7,1},value= root:DP_TestPulse:adcIndex	SetVariable testPulseAmplitudeSetVariable,pos={200+30,10},size={100,1},title="amplitude"	SetVariable testPulseAmplitudeSetVariable,limits={-1000,1000,1},value= root:DP_TestPulse:amplitude	SetVariable duration,pos={200+30,30},size={100,1},title="duration  "	SetVariable duration,limits={1,1000,1},value= root:DP_TestPulse:duration	TitleBox msTitleBox,pos={300+30+4,30+1},frame=0,title="ms"		CheckBox testPulseBaseSubCheckbox,pos={110+30,56},size={58,14},title="Base Sub"	Checkbox testPulseBaseSubCheckbox,value=doBaselineSubtraction	Checkbox testPulseBaseSubCheckbox,proc=TestPulseBaseSubCheckboxUsed	CheckBox ttlOutputCheckbox,pos={200+30+20,56},size={58,14},title="TTL Output"	CheckBox ttlOutputCheckbox,proc=ttlOutputCheckboxUsed,value=ttlOutput	SetVariable ttlOutChannelSetVariable,pos={280+30+20,56-1},size={44,1},title="#"	SetVariable ttlOutChannelSetVariable,limits={0,3,1},value= root:DP_TestPulse:ttlOutIndex	SetVariable ttlOutChannelSetVariable,disable=2-2*ttlOutput	// Draw the bottom "panel"	ControlBar /B /W=TestPulseWindow 30	// Widgets for showing the seal resistance	ValDisplay RSealValDisplay,pos={236,380},size={120,17},fSize=12,format="%10.3f"	ValDisplay RSealValDisplay,limits={0,0,0},barmisc={0,1000},value= _NUM:RSeal	ValDisplay RSealValDisplay,title="Resistance:"	TitleBox GOhmTitleBox,pos={236+126,380+1},frame=0,title="GOhm"	WhiteOutIffNan("RSealValDisplay","TestPulseWindow",RSeal)		// ValDisplay for showing the update rate	ValDisplay updateRateValDisplay,pos={10,380},size={120,17},fSize=12,format="%6.1f"	ValDisplay updateRateValDisplay,limits={0,0,0},barmisc={0,1000},value= _NUM:updateRate	ValDisplay updateRateValDisplay,title="Update rate:"	TitleBox hzTitleBox,pos={10+126,380+1},frame=0,title="Hz"	WhiteOutIffNan("updateRateValDisplay","TestPulseWindow",updateRate)		// Restore the original DF	SetDataFolder savedDFEnd//----------------------------------------------------------------------------------------------------------------------------Function DeliverTestPulses()	// Deliver repeated test pulses, acquire response, display.	// Set DF	String savedDF=GetDataFolder(1)	SetDataFolder root:DP_TestPulse	// Declare instance variables	NVAR dacIndex	// index of DAC channel to use for test pulse	NVAR adcIndex	// index of ADC channel to use for test pulse	NVAR amplitude, duration	NVAR dt	NVAR ttlOutput		// boolean, true iff we're to also have a TTL output go high when pulsing	NVAR ttlOutIndex		// index of the TTL output channel to use	NVAR doBaselineSubtraction	NVAR RSeal	NVAR updateRate		// Build the test pulse wave	Wave TestPulse_TTL=SimplePulseBoolean(dt,0.5*duration,duration,0.5*duration)		// free wave	Variable nScans=numpnts(TestPulse_TTL)	Make /FREE /N=(nScans) TestPulse_DAC	TestPulse_DAC=amplitude*TestPulse_TTL	// Create the wave we'll display, which is all-zeros for now 	Make /O /N=(nScans) TestPulse_ADC		// This is a bound wave, b/c it has to live on after we exit	Setscale /P x, 0, dt, "ms", TestPulse_ADC	// Bring the test pulse panel to the front	DoWindow /F TestPulseWindow		// Multiplex the TTL wave, if called for	if (ttlOutput)		TestPulse_TTL=(2^ttlOutIndex)*TestPulse_TTL	// multiplexing	endif		// Build FIFOout for the test pulse	Variable outGain=GetDACPointsPerNativeUnit(dacIndex)	Variable inGain=GetADCNativeUnitsPerPoint(adcIndex)	String daSequence=num2str(dacIndex)	String adSequence=num2str(adcIndex)	if (ttlOutput)		daSequence+="D"		adSequence+=num2str(adcIndex)		Make /FREE /N=(nScans*2) FIFOout		Setscale /P x, 0, dt/2, "ms", FIFOout		//FIFOout[0,;2]=TestPulse_DAC[p/2]*outGain*dacMultiplier[dacIndex]		FIFOout[0,;2]=TestPulse_DAC[p/2]*outGain		FIFOout[1,;2]=TestPulse_TTL[p/2]	else		//Duplicate /FREE TestPulse_DAC FIFOout			Make /FREE /N=(nScans) FIFOout		Setscale /P x, 0, dt, "ms", FIFOout		//Duplicate /FREE TestPulse_DAC FIFOout			//FIFOout=TestPulse_DAC*outGain*dacMultiplier[dacIndex]		FIFOout=TestPulse_DAC*outGain	endif		// Specify the time windows for measuring the baseline and the pulse amplitude	Variable totalDuration=2*duration	Variable t0Base=0	Variable tfBase=1/8*totalDuration	Variable t0Pulse=5/8*totalDuration	Variable tfPulse=6/8*totalDuration			// Deliver test pulse, plot response, repeat until user wants to stop	Variable base, pulse	Variable timer	Variable usElapsed	Variable adcMode=GetADCChannelMode(adcIndex)	Variable dacMode=GetDACChannelMode(dacIndex)			Variable i	TitleBox proTipTitleBox,win=TestPulseWindow,disable=0		// tell the user how to break out of the loop	timer=startMSTimer		// start the timer	for (i=0; !EscapeKeyWasPressed(); i+=1)		// execute the sample sequence		Wave FIFOin=SampleData(adSequence,daSequence,FIFOout)		// extract TestPulse_ADC from FIFOin		if (ttlOutput)			TestPulse_ADC=FIFOin[2*p]*inGain		else			TestPulse_ADC=FIFOin*inGain		endif		//KillWaves FIFOin		// Don't need FIFOin anymore		if (doBaselineSubtraction)			Wavestats /Q/R=[5,45] TestPulse_ADC			TestPulse_ADC-=V_avg		endif		// If first iteration, do first-time things		if (i==0)			// if TestPulse_ADC is not currently being shown in the graph, append it			String traceList=TraceNameList("TestPulseWindow",";",3)  // 3 means all traces			Variable nTraces=ItemsInList(traceList)			Variable waveInGraph=(nTraces>0)		// assume that if there's a wave in there, it's TestPulse_ADC				if (!waveInGraph)				AppendToGraph /W=TestPulseWindow TestPulse_ADC				ModifyGraph grid(left)=1				ModifyGraph tickUnit(bottom)=1			endif			// set display range, axis labels, etc.			MatchYAxisLimitsToTrace()			SyncAxisLabelsToModel()		endif		// Calculate the seal resistance		base=mean(TestPulse_ADC,t0Base,tfBase)		pulse=mean(TestPulse_ADC,t0Pulse,tfPulse)		if (adcMode==0 && dacMode==1)			// ADC channel is a current channel, DAC channel is a voltage channel			RSeal=amplitude/(pulse-base)		elseif (adcMode==1 && dacMode==0)			// output channel is a voltage channel			RSeal=(pulse-base)/amplitude		else			Printf "ADC and DAC channel for test pulse are of same type, therefore the 'resistance' is unitless!\r"			RSeal=nan		endif		ValDisplay RSealValDisplay,win=TestPulseWindow,value= _NUM:RSeal		WhiteOutIffNan("RSealValDisplay","TestPulseWindow",RSeal)		// Calculate the update rate		usElapsed=stopMSTimer(timer)		// Make sure we really had a timer for that last iteration		if (timer!=-1)			updateRate=1e6/usElapsed	// Hz		else			updateRate=nan	// Hz		endif				timer=startMSTimer		ValDisplay updateRateValDisplay,win=TestPulseWindow,value= _NUM:updateRate		//ValDisplay updateRateValDisplay,win=TestPulseWindow,value= _NUM:msElapsed2		WhiteOutIffNan("updateRateValDisplay","TestPulseWindow",updateRate)		// Update the graph		DoUpdate /W=TestPulseWindow	endfor	usElapsed=stopMSTimer(timer)	// stop the timer, and free it	//while (HaltProcedures()<1)	TitleBox proTipTitleBox,win=TestPulseWindow,disable=1		// hide the tip	//// Kill the graph	//DoWindow /K TestPulseGraph		// Bring the test pulse panel forward now that we're done	DoWindow /F TestPulseWindow		// Kill the ADC wave, so it's not hanging around in the DF after we exit	//KillWaves TestPulse_ADC		// Restore the original DF	SetDataFolder savedDFEnd//----------------------------------------------------------------------------------------------------------------------------Function TPStartButtonProc(ctrlName) : ButtonControl	String ctrlName	DeliverTestPulses()EndFunction TestPulseBaseSubCheckboxUsed(ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	String savedDF=GetDataFolder(1)	SetDataFolder root:DP_TestPulse	NVAR doBaselineSubtraction	doBaselineSubtraction=checked		SetDataFolder savedDFEndFunction ttlOutputCheckboxUsed(ctrlName,checked) : CheckBoxControl	String ctrlName	Variable checked	String savedDF=GetDataFolder(1)	SetDataFolder root:DP_TestPulse	NVAR ttlOutput	ttlOutput=checked	SetVariable ttlOutChannelSetVariable,win=TestPulseWindow,disable=2-2*ttlOutput		SetDataFolder savedDFEndFunction MatchYAxisLimitsToTrace()	// private method	String savedDF=GetDataFolder(1)	SetDataFolder root:DP_TestPulse	if (WaveExists(TestPulse_ADC))			// set display range, axis labels, etc.		Variable miny, maxy		Wavestats /Q TestPulse_ADC		miny=1.2*V_min		maxy=1.2*V_max		miny-=maxy/10		if (miny>-0.2)			miny=-0.2		endif		if (maxy<0.2)			maxy=0.2		endif		Setaxis left, miny, maxy	endif	SetDataFolder savedDFEndFunction SyncAxisLabelsToModel()	// private method	String savedDF=GetDataFolder(1)	SetDataFolder root:DP_TestPulse	NVAR adcIndex		if (WaveExists(TestPulse_ADC))			Label bottom "\\F'Helvetica'\\Z12\\f01Time (ms)"		String adcModeString=GetADCChannelModeString(adcIndex)		String adcUnitsString=GetADCChannelUnitsString(adcIndex)			Label left sprintf2ss("\\F'Helvetica'\\Z12\\f01%s (%s)",adcModeString,adcUnitsString)	endif	SetDataFolder savedDFEnd