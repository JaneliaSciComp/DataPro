//	DataPro Utilities//	last updated 12/29/99#pragma rtGlobals=1		// Use modern global access method.#include <Strings as Lists>#include <Axis Utilities>//---------------------- Graph Axis Scaling Procedures -----------------------////Function RescaleTopAxes()//	// Calls RescaleAxes() on the top DPBrowser//	Variable browserNumber=GetTopBrowserNumber()//	RescaleAxes(browserNumber)//End//Function SyncDFAxesLimitsWithGraph(browserNumber)//	// Reads the axes limits from the graph of the given DPBrowser, and writes those values to the//	// xMin, xMax, etc. variables in the DF//	Variable browserNumber////	// Switch the DF to the browser DF, note the former DF name//	String savedDFName=ChangeToBrowserDF(browserNumber)////	// Get the window name of the DPBrowser//	String browserName=BrowserNameFromNumber(browserNumber)////	// Get the graph limits, set the ones stored in the browser DF to those//	NVAR xMin=xMin, xMax=xMax//	NVAR yAMin=yAMin, yAMax=yAMax//	NVAR yBMin=yBMin, yBMax=yBMax//	GetAxis /W=$browserName /Q bottom//	xMin=V_min; xMax=V_max//	GetAxis /W=$browserName /Q left//	yAMin=V_min; yAMax=V_max//	GetAxis /W=$browserName /Q right//	yBMin=V_min; yBMax=V_max//	//	// Restore old DF//	SetDataFolder savedDFName//EndFunction PlaceCursors(where)	String where	NVAR acsrx=acsrx, bcsrx=bcsrx	Cursor /C=(0,0,0) A, $where, acsrx	Cursor /C=(0,0,0) B, $where, bcsrxEnd//------------------FUNCTIONS AND PROCEDURES FOR WAVE NOTES------------------//Function WriteWaveNote(theWave, theNote, theValue)	Wave theWave	String theNote, theValue	Variable start, first, last	String oldnote, newnote	oldnote=note(theWave)	start=strsearch(oldnote,theNote,0)	first=strsearch(oldnote,"=",start)	last=strsearch(oldnote,"\r", first)	if (start<0)		sprintf newnote, "%s=%s", theNote, theValue	else		sprintf newnote, "%s%s%s", oldnote[0,first], theValue,oldnote[last,strlen(oldnote)]		Note /K theWave	endif	Note theWave, newnoteEndFunction GetWaveNoteNumber(theWave, theNote)	Wave theWave	String theNote	Variable start, theValue	String oldnote, newnote//	String savDF=GetDataFolder(1)//	SetDataFolder root:	oldnote=note(theWave)	start=strsearch(oldnote,theNote,0)	if (start<0)		if (cmpstr(theNote,"BASELINE")==0)			Wavestats /Q/R=[0,100] theWave			theValue=V_avg		else			theValue=0		endif		sprintf newnote, "%s=%f", theNote, theValue		Note theWave, newnote	endif	theValue=NumberByKey(theNote, note(theWave), "=", "\r")	return theValue//	SetDataFolder savDFEndFunction /S GetWaveNoteString(theWave, theNote)	Wave theWave	String theNote	String savDF=GetDataFolder(1)	SetDataFolder root:	Variable start	String theValue, oldnote, newnote	oldnote=note(theWave)	start=strsearch(oldnote,theNote,0)	if (start<0)		sprintf newnote, "%s=0", theNote		Note theWave, newnote	endif	theValue=StringByKey(theNote, Note(theWave), "=", "\r")	SetDataFolder savDF	return theValueEndFunction/S GetPopupItems(flag)	String flag	String theFolderPath = "root:DP_ADCDACcontrol"	if (!DataFolderExists(theFolderPath))		return ""	endif	String dfSave = GetDataFolder(1)	SetDataFolder theFolderPath	String items, theString	theString="*_"+flag	items=WaveList(theString, ";", "")	SetDataFolder dfSave		return itemsEndFunction PanelExists(windowName)	String windowName	String windowList=WinList(windowName,";","WIN:64")  // 64 is code for panel	Variable nItems=ItemsInList(windowList)	return (nItems>0)EndFunction IsItemInList(itemStr,listStr)	String itemStr, listStr	Variable i=FindListItem(itemStr,listStr)  // returns -1 if item not in list	return (i>=0)EndFunction ToolsPanelExists(browserNumber)	Variable browserNumber	String browserName=BrowserNameFromNumber(browserNumber)	String windowList=ChildWindowList(browserName)	return IsItemInList("ToolsPanel",windowList)EndFunction GraphExists(windowName)	String windowName	return (strlen(WinList(windowName,";","WIN:1"))>0)  // 1 is code for graphEndFunction KillToolsPanel(browserNumber)	Variable browserNumber	String panelName=ToolsPanelNameFromNumber(browserNumber)	KillWindow $panelNameEndFunction /S sprintf1d(templateString,i)	String templateString	Variable i		String outputString	sprintf outputString templateString i	return outputStringEndFunction /S sprintf1s(templateString,str)	String templateString	String str		String outputString	sprintf outputString templateString str	return outputStringEndFunction /S sprintf2sd(templateString,str,i)	String templateString	String str	Variable i		String outputString	sprintf outputString templateString str, i	return outputStringEndFunction /S BrowserNameFromNumber(browserNumber)	Variable browserNumber	String browserName	sprintf browserName "DataProBrowser%d" browserNumber	return browserNameEndFunction /S MeasurePanelNameFromNumber(browserNumber)	Variable browserNumber	String measurePanelName	sprintf measurePanelName "MeasurePanel%d" browserNumber	return measurePanelNameEndFunction /S ToolsPanelNameFromNumber(browserNumber)	Variable browserNumber	String panelName	sprintf panelName "DataProBrowser%d#ToolsPanel" browserNumber	return panelNameEndFunction /S FitPanelNameFromNumber(browserNumber)	Variable browserNumber	String windowName	sprintf windowName "FitPanel%d" browserNumber	return windowNameEndFunction /S AveragePanelNameFromNumber(browserNumber)	Variable browserNumber	String windowName	sprintf windowName "AveragePanel%d" browserNumber	return windowNameEndFunction BrowserNumberFromName(browserName)	String browserName	String baseName, browserNumberAsString	SplitString /E="([a-zA-Z]*)([0-9]+)" browserName, baseName, browserNumberAsString	// Convert to a number (not a string) and return	Variable browserNumber=str2num(browserNumberAsString)  // will be nan if a non-number string	return browserNumberEndFunction /S BrowserTitleFromNumber(browserNumber)	Variable browserNumber	String browserTitle	sprintf browserTitle "DataProBrowser %d" browserNumber	return browserTitleEndFunction /S BrowserDFNameFromNumber(browserNumber)	Variable browserNumber	String browserDFName	sprintf browserDFName "root:DP_Browser_%d" browserNumber	return browserDFNameEndFunction /S AbsoluteVarName(DFName,localVarName)	String dfName, localVarName	String absVarName	sprintf absVarName "%s:%s" DFName, localVarName	return absVarNameEndFunction GetTopBrowserNumber()	//windowName=WinName(0,1)	String windowList=WinList("DataProBrowser*",";","WIN:1")	if (strlen(windowList)==0)		return NaN  // signals that there are no DataProBrowser windows	endif	String windowName, moreWindowNames	SplitString /E="([a-zA-Z0-9]*);(.*)" windowList, windowName, moreWindowNames	if (strlen(windowName)==0)		return NaN  // signals that there are no DataProBrowser windows	endif	Variable browserNumber=BrowserNumberFromName(windowName)	return browserNumberEnd//Function DetermineBrowserNumberForNew()//	String topwin, key, doit//	Variable browserNumber//	String windowName, windowNameCheck//	Variable done=0//	for (browserNumber=0;!done;browserNumber+=1)//		sprintf windowName, "DataProBrowser%d", browserNumber//		windowNameCheck=WinList(windowName,"","")//		if (strlen(windowNameCheck)==0)//			done=1//			break  // don't wan't browserNumber incremented at end of this iteration//		endif//	endfor//	// browserNumber is now the number of the next DataProBrowser window//	return browserNumber//EndFunction LargestBrowserNumber()	// The number of the largest-numbered DP Browser currently extant. -1 if there are no DP Browsers.	String browserList=WinList("DataProBrowser*",";","WIN:1")	// 1 means graph windows	Variable n=ItemsInList(browserList)	Variable i, browserNumber, browserNumberMax=-1	String browserName	for (i=0; i<n; i+=1)		browserName=StringFromList(i,browserList)		browserNumber=BrowserNumberFromName(browserName)		browserNumberMax=max(browserNumberMax,browserNumber)	endfor	return browserNumberMaxEndFunction /S ChangeToBrowserDF(browserNumber)	Variable browserNumber	// Save the current DF, set the data folder to the appropriate one for this DataProBrowser instance	String savedDFName=GetDataFolder(1)	String browserDFName=BrowserDFNameFromNumber(browserNumber)	SetDataFolder browserDFName	return savedDFNameEndFunction NTracesFromBaseName(baseName)	// Determine the number of traces with the given baseName in the root DF.	String baseName		String savedDFName=GetDataFolder(1)	SetDataFolder root:	String theWaveList=WaveList(baseName+"*", ";", "")	SetDataFolder savedDFName		Variable nTraces=ItemsInList(theWaveList)	return nTracesEndFunction /S WaveNameFromBaseAndSweep(baseName,iSweep)	String baseName	Variable iSweep	String theWaveName	sprintf theWaveName "%s%d" baseName, iSweep	return theWaveNameEndFunction /S TraceLetterFromIndex(i)	// Converts from a trace index (0 or 1) to a trace letter ("A" or "B")	Variable i	String letter	if (i==0)		letter="A"	else		letter="B"	endif	return letterEndFunction RemoveFromGraphAll(graphName)	String graphName		String traceList=TraceNameList(graphName,";",3)  // 3 means all traces	Variable nTraces=ItemsInList(traceList)	Variable i	String thisTraceName	for (i=0; i<nTraces; i+=1)		thisTraceName=StringFromList(i,traceList)		RemoveFromGraph /W=$graphName $thisTraceName	endforEndFunction /S RootWindowName(subwindowName)	// Given an absolute subwindow name, returns the name of the root window of the subwindow 	String subwindowName 		String rootName=StringFromList(0,subwindowName,"#")	return rootNameEndFunction AreCursorsAAndBSet(graphName)	// Returns 1 if both cursors A and B are set, 0 otherwise	String graphName	return ( IsCursorASet(graphName) && IsCursorBSet(graphName) )EndFunction IsCursorASet(graphName)	String graphName	String kvList=CsrInfo(A,graphName)	if (strlen(kvList)==0)		return 0	endif	return 1EndFunction IsCursorBSet(graphName)	String graphName	String kvList=CsrInfo(B,graphName)	if (strlen(kvList)==0)		return 0	endif	return 1EndFunction IsNan(x)	Variable x	return (NumType(x)==2)EndFunction IsInf(x)	Variable x	return (NumType(x)==1)EndFunction IsFinite(x)	Variable x	return (NumType(x)==0)EndFunction AreStringsEqual(str1,str2)	String str1,str2	return (cmpstr(str1,str2)==0)EndFunction RiseTime(thisWave,tLeft,tRight,yBase,dyPeak,fracFrom,fracTo)	Wave thisWave	Variable tLeft,tRight, yBase, dyPeak, fracFrom, fracTo	Variable yFrom=yBase+fracFrom*dyPeak	FindLevel /Q/R=(tLeft,tRight) thisWave, yFrom  // find level crossing	Variable tFrom= (V_flag==0) ? V_LevelX : NaN	Variable yTo=yBase+fracTo*dyPeak	FindLevel /Q/R=(tLeft,tRight) thisWave, yTo  // find level crossing	Variable tTo= (V_flag==0) ? V_LevelX : NaN	Variable tRise=tTo-tFrom	return tRiseEndFunction CountThresholdCrossings(theWaveName, tWindowLeft, tWindowRight, threshold)	String theWaveName	Variable tWindowLeft, tWindowRight, threshold	if ( strlen(theWaveName)==0 || IsNan(tWindowLeft) || IsNan(tWindowRight) || IsNan(threshold) )		return nan	endif	FindLevels /Q/R=(tWindowLeft,tWindowRight) $theWaveName, threshold	return V_LevelsFoundEndFunction WhiteOutIffNan(valDisplayName,windowName,value)	// Sets the foreground text color to white if the named ValDisplay is nan, black otherwise	String valDisplayName, windowName	Variable value		// Tried this, but doesn't work reliably because of exactly when IgorPro syncs bindings	//ControlInfo /W=$windowName $valDisplayName	//Variable value=V_value	if ( IsNan(value) )		ValDisplay $valDisplayName, win=$windowName, valueColor=(65535,65535,65535)	else		ValDisplay $valDisplayName, win=$windowName, valueColor=(0,0,0)	endif	End