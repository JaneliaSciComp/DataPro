//	DataPro Analysis//	Adapted from BAD_ASS//	(Browse, Analyze Data, and Average Selected Sweeps, Nelson Spruston, 8/95)//	DataPro Analyze began 8/24/99//	last updated 7/23/02#pragma rtGlobals=1		// Use modern global access method.//________________________DataPro Analyze ______________________//Function AnalyzeButtonProc(ctrlName) : ButtonControl	String ctrlName	Execute "Analysis()"EndFunction GoToSweep(svStruct) : SetVariableControl	// Called when the user changes the sweep number in the DPBrowser, 	// which first changes iCurrentSweep.	STRUCT WMSetVariableAction &svStruct		if ( svStruct.eventCode==-1 ) 		return 0	endif		String browserName=svStruct.win	ControlInfo /W=$browserName setsweep	Variable iSweepInView=V_Value	Variable browserNumber=BrowserNumberFromName(browserName)	SweepIndexChangedInView(browserNumber,iSweepInView)EndFunction HandleBaseNameControl(svStruct) : SetVariableControl	// Called when the user changes the trace name in the control.	STRUCT WMSetVariableAction &svStruct		if ( svStruct.eventCode!=2 && svStruct.eventCode!=3 && svStruct.eventCode!=6 ) 		return 0	endif		String browserName=svStruct.win	Variable browserNumber=BrowserNumberFromName(browserName)	SyncBrowserViewToDFState(browserNumber)EndFunction SweepIndexChangedInView(browserNumber,sweepIndexInView)	// Tell the controller that the sweep index has been changed in the view.	Variable browserNumber, sweepIndexInView	// Change to the right DF	String savedDFName=ChangeToBrowserDF(browserNumber)	//	// Synthesize and store the names of the new waves//	SVAR baseNameA=baseNameA//	String newWave1NameMaybe//	sprintf newWave1NameMaybe "root:%s%d", baseNameA, sweepIndexInView//	SVAR baseNameB=baseNameB//	String newWave2NameMaybe	//	sprintf newWave2NameMaybe "root:%s%d", baseNameB, sweepIndexInView//	//	// Check that one of the sweeps exists.  If not, roll back the value//	// I think this code is no longer necessary, since the sweep index control now has//	// proper limits.//	if ( !WaveExists($newWave1NameMaybe) && !WaveExists($newWave2NameMaybe) )//		NVAR iCurrentSweep=iCurrentSweep//		String browserName=BrowserNameFromNumber(browserNumber)//		SetVariable setsweep, win=$browserName, value=_NUM:iCurrentSweep//		return 0//	endif	// Set the sweep in the "controller"	SetICurrentSweep(browserNumber,sweepIndexInView)		// Restore the original DF	SetDataFolder savedDFName	EndFunction SetICurrentSweep(browserNumber,sweepIndexNew)	// Set the current sweep index to something, which is assumed to be valid.	Variable browserNumber, sweepIndexNew	// Change to the right DF	String savedDFName=ChangeToBrowserDF(browserNumber)		// Set iCurrentSweep, then sync the view with the "controller" state	NVAR iCurrentSweep=iCurrentSweep	iCurrentSweep=sweepIndexNew	SyncBrowserViewToDFState(browserNumber)		// Restore the original DF	SetDataFolder savedDFName	EndFunction SyncBrowserViewToDFState(browserNumber)	// This syncs the indicated DPBrowser view to the values of the state variables in the browser's DF,	// which are assumed to be self-consistent.	Variable browserNumber		// Find name of top browser, switch the DF to its DF, note the former DF name	//Variable browserNumber=GetTopBrowserNumber()	String savedDFName=ChangeToBrowserDF(browserNumber)	// Get references to the DF vars we need	NVAR iCurrentSweep=iCurrentSweep	NVAR clamp_mode=root:DP_ADCDACcontrol:clamp_mode	NVAR traceAChecked=traceAChecked	NVAR traceBChecked=traceBChecked		SVAR baseNameA=baseNameA	SVAR baseNameB=baseNameB	SVAR comments=comments	WAVE Colors=Colors	NVAR showToolsChecked=showToolsChecked	NVAR tBaselineLeft=tBaselineLeft	NVAR tBaselineRight=tBaselineRight	NVAR tWindow1Left=tWindow1Left	NVAR tWindow1Right=tWindow1Right	NVAR tWindow2Left=tWindow2Left	NVAR tWindow2Right=tWindow2Right	NVAR tFitZero=tFitZero	NVAR tFitLeft=tFitLeft	NVAR tFitRight=tFitRight	NVAR yAMin=yAMin	NVAR yAMax=yAMax	NVAR yBMin=yBMin	NVAR yBMax=yBMax		NVAR xMin=xMin	NVAR xMax=xMax	NVAR tCursorA	NVAR tCursorB		// Turn off output to console	Silent 1		// Note which axes currently exist	String browserName=BrowserNameFromNumber(browserNumber)	Variable leftAxisExists=0, rightAxisExists=0, bottomAxisExists=0		// boolean	GetAxis /W=$browserName /Q left	if (V_flag==0)  // V_flag will be zero if the axis actually exists		leftAxisExists=1;	endif	GetAxis /W=$browserName /Q right	if (V_flag==0)  // V_flag will be zero if the axis actually exists		rightAxisExists=1;	endif	GetAxis /W=$browserName /Q bottom	if (V_flag==0)  // V_flag will be zero if the axis actually exists		bottomAxisExists=1;	endif		// Remove the old waves from the graph	RemoveFromGraphAll(browserName)		// Update the viable range for the current sweep control, and the current sweep	Variable nSweeps1=NTracesFromBaseName(baseNameA)	Variable nSweeps2=NTracesFromBaseName(baseNameB)	Variable nSweeps=max(nSweeps1,nSweeps2)	if (nSweeps>0)		SetVariable setsweep, win=$browserName, limits={1,nSweeps,1}		SetVariable setsweep, win=$browserName, value=_NUM:iCurrentSweep	else		SetVariable setsweep, win=$browserName, limits={1,nSweeps,0}		SetVariable setsweep, win=$browserName, value=_STR:"(none)"			endif		// If either wave exists, do baseline subtraction	String traceAWaveNameAbs=GetTraceAWaveNameAbs(browserNumber)	String traceBWaveNameAbs=GetTraceBWaveNameAbs(browserNumber)	Variable waveAExists=WaveExists($traceAWaveNameAbs)	Variable waveBExists=WaveExists($traceBWaveNameAbs)	if (waveAExists || waveBExists)		DoBaseSub(browserNumber)	endif	// topTraceWaveName should be empty if no traces are showing	// same for comments	comments=""	// If it exists, add $traceBWaveNameAbs to the graph		if (traceBChecked && waveBExists)		AppendToGraph /W=$browserName /R /C=(Colors[1][0],Colors[1][1],Colors[1][2]) $traceBWaveNameAbs		comments=GetWaveNoteString($traceBWaveNameAbs,"COMMENTS")	endif		// If it exists, add $traceAWaveNameAbs to the graph		if (traceAChecked && waveAExists)		AppendToGraph /W=$browserName /C=(Colors[0][0],Colors[0][1],Colors[0][2]) $traceAWaveNameAbs		comments=GetWaveNoteString($traceAWaveNameAbs,"COMMENTS")	endif		// Put the cursors back	String topTraceWaveNameRel=GetTopTraceWaveNameRel(browserNumber)	if (strlen(topTraceWaveNameRel)>0 && IsFinite(tCursorA))		Cursor /W=$browserName A $topTraceWaveNameRel tCursorA	endif	if (strlen(topTraceWaveNameRel)>0 && IsFinite(tCursorB))		Cursor /W=$browserName B $topTraceWaveNameRel tCursorB	endif		// Draw the vertical lines	if (showToolsChecked && ( (traceAChecked && waveAExists) || (traceBChecked && waveBExists) ) )		if (IsFinite(tBaselineLeft))	 		AddCursorLineToGraph(browserName,"baselineMarkerLeft",tBaselineLeft,65535,0,0)	 	endif		if (IsFinite(tBaselineRight))  // true if non-nan			AddCursorLineToGraph(browserName,"baselineMarkerRight",tBaselineRight,65535,0,0)		endif		if (IsFinite(tWindow1Left))  // true if non-nan			AddCursorLineToGraph(browserName,"window1MarkerLeft",tWindow1Left,3,52428,1)		endif		if (IsFinite(tWindow1Right))  // true if non-nan			AddCursorLineToGraph(browserName,"window1MarkerRight",tWindow1Right,3,52428,1)		endif		if (IsFinite(tWindow2Left))  // true if non-nan			AddCursorLineToGraph(browserName,"window2MarkerLeft",tWindow2Left,0,0,65535)		endif		if (IsFinite(tWindow2Right))  // true if non-nan			AddCursorLineToGraph(browserName,"window2MarkerRight",tWindow2Right,0,0,65535)		endif		if (IsFinite(tFitZero))			AddCursorLineToGraph(browserName,"fitLineZero",tFitZero,26411,1,52428)		endif		if (IsFinite(tFitLeft))			AddCursorLineToGraph(browserName,"fitLineLeft",tFitLeft,0,65535,65535)		endif		if (IsFinite(tFitRight))			AddCursorLineToGraph(browserName,"fitLineRight",tFitRight,0,65535,65535)		endif	endif		// Update the rejection box to reflect the reject-status of each wave 	UpdateRejectBox(browserNumber)		// Get the metadata associated with each wave, put relevant values in DF variables	NVAR hold1=hold1, step1=step1	if (waveAExists && traceAChecked)		hold1=GetWaveNoteNumber($traceAWaveNameAbs,"BASELINE")		step1=GetWaveNoteNumber($traceAWaveNameAbs,"STEP")	else		hold1=NaN;		step1=NaN;	endif	NVAR hold2=hold2, step2=step2	if (waveBExists && traceBChecked)		hold2=GetWaveNoteNumber($traceBWaveNameAbs,"BASELINE")		step2=GetWaveNoteNumber($traceBWaveNameAbs,"STEP")	else		hold2=NaN;		step2=NaN;	endif		// If there is one or more trace in the graph, make sure the axes of the graph are	// consistent with the autoscaling checkboxes, and turn on horizontal grid lines.	String topTraceWaveNameAbs=GetTopTraceWaveNameAbs(browserNumber)	if (ItemsInList(TraceNameList(browserName,";",1))>0)		RescaleAxes(browserNumber)  // Scale the axes properly, based on the model state		if (cmpstr(topTraceWaveNameAbs,traceAWaveNameAbs)==0)			ModifyGraph /W=$browserName /Z grid(left)=1			ModifyGraph /W=$browserName /Z gridRGB(left)=(0,0,0)		elseif (cmpstr(topTraceWaveNameAbs,traceBWaveNameAbs)==0)			ModifyGraph /W=$browserName /Z grid(right)=1			ModifyGraph /W=$browserName /Z gridRGB(right)=(0,0,0)		endif	endif	// Set axis labels on the graph	String traceADisplayName=WaveNameFromBaseAndSweep(baseNameA,iCurrentSweep)	String traceBDisplayName=WaveNameFromBaseAndSweep(baseNameB,iCurrentSweep)	Label /W=$browserName /Z bottom "\\F'Helvetica'\\Z12\\f01Time (ms)"	if (clamp_mode<1)		Label /W=$browserName /Z left "\\F'Helvetica'\\Z12\\f01\K(0,0,0)"+traceADisplayName+" (pA)"		Label /W=$browserName /Z right "\\F'Helvetica'\\Z12\\f01\K(32768,32768,32768)"+traceBDisplayName+" (mV)"	else		Label /W=$browserName /Z left "\\F'Helvetica'\\Z12\\f01\K(0,0,0)"+traceADisplayName+" (mV)"		Label /W=$browserName /Z right "\\F'Helvetica'\\Z12\\f01\K(32768,32768,32768)"+traceBDisplayName+" (pA)"	endif	// Show/hide the tools panel, as appropriate to the state		//String toolsPanelName=ToolsPanelNameFromNumber(browserNumber)	if (showToolsChecked) 		if (ToolsPanelExists(browserNumber))			//DoWindow /F $toolsPanelName		else			String createPanel			sprintf createPanel "NewToolsPanel(%d)" browserNumber			Execute createPanel		endif		// Update all the measured values for this DP browser		UpdateMeasurementsAndFit(browserNumber)	else		if (ToolsPanelExists(browserNumber))			String toDo			sprintf toDo "KillToolsPanel(%d)" browserNumber			Execute toDo		endif	endif		// Restore old data folder	SetDataFolder savedDFNameEndFunction /S GetTopTraceWaveNameAbs(browserNumber)	// Returns the absolute wave name of the "top" trace, or the emprty string if no trace is showing.	// If trace A is showing, it is the top trace.  Otherwise, if trace B is showing, it is the top trace.	// Otherwise, there is no top trace.	Variable browserNumber	// Find name of top browser, switch the DF to its DF, note the former DF name	//Variable browserNumber=GetTopBrowserNumber()	String savedDFName=ChangeToBrowserDF(browserNumber)		NVAR iCurrentSweep=iCurrentSweep	NVAR traceAChecked=traceAChecked	NVAR traceBChecked=traceBChecked		SVAR baseNameA=baseNameA, baseNameB=baseNameB	String traceAWaveName=GetTraceAWaveNameAbs(browserNumber)	String traceBWaveName=GetTraceBWaveNameAbs(browserNumber)	Variable waveAExists=WaveExists($traceAWaveName)	Variable waveBExists=WaveExists($traceBWaveName)	String retval	if (traceAChecked && waveAExists)		retval=traceAWaveName	elseif (traceBChecked && waveBExists)		retval=traceBWaveName	else		retval=""	endif	// Restore old data folder	SetDataFolder savedDFName		return retvalEndFunction /S GetTopTraceWaveNameRel(browserNumber)	// Returns the wave name of the "top" trace, relative to the data folder containing it, or the empty 	// string if no 	// trace is showing.	// If trace A is showing, it is the top trace.  Otherwise, if trace B is showing, it is the top trace.	// Otherwise, there is no top trace.	Variable browserNumber	// Find name of top browser, switch the DF to its DF, note the former DF name	//Variable browserNumber=GetTopBrowserNumber()	String savedDFName=ChangeToBrowserDF(browserNumber)		NVAR iCurrentSweep=iCurrentSweep	NVAR traceAChecked=traceAChecked	NVAR traceBChecked=traceBChecked		SVAR baseNameA=baseNameA, baseNameB=baseNameB	String traceAWaveNameRel=GetTraceAWaveNameRel(browserNumber)	String traceBWaveNameRel=GetTraceBWaveNameRel(browserNumber)	String traceAWaveNameAbs=GetTraceAWaveNameAbs(browserNumber)	String traceBWaveNameAbs=GetTraceBWaveNameAbs(browserNumber)	Variable waveAExists=WaveExists($traceAWaveNameAbs)	Variable waveBExists=WaveExists($traceBWaveNameAbs)	String retval	if (traceAChecked && waveAExists)		retval=traceAWaveNameRel	elseif (traceBChecked && waveBExists)		retval=traceBWaveNameRel	else		retval=""	endif	// Restore old data folder	SetDataFolder savedDFName		return retvalEndFunction /S GetTraceAWaveNameAbs(browserNumber)	// Construct the absolute wave name of trace A in the given browser number.  Note that this wave may or	// may not exist.	Variable browserNumber	return "root:"+GetTraceAWaveNameRel(browserNumber)EndFunction /S GetTraceBWaveNameAbs(browserNumber)	// Construct the absolute wave name of trace B in the given browser number.  Note that this wave may 	// or may not exist.	Variable browserNumber	return "root:"+GetTraceBWaveNameRel(browserNumber)EndFunction /S GetTraceAWaveNameRel(browserNumber)	// Construct the wave name of trace A in the given browser number, relative to the data folder containing it.  	// Note that this wave may or may not exist.	Variable browserNumber	String savedDFName=ChangeToBrowserDF(browserNumber)	NVAR iCurrentSweep=iCurrentSweep	SVAR baseNameA=baseNameA	String retval=sprintf2sd("%s%d", baseNameA, iCurrentSweep)	SetDataFolder savedDFName	return retvalEndFunction /S GetTraceBWaveNameRel(browserNumber)	// Construct the wave name of trace B in the given browser number, relative to the data folder containing it.  	// Note that this wave may or may not exist.	Variable browserNumber	String savedDFName=ChangeToBrowserDF(browserNumber)	NVAR iCurrentSweep=iCurrentSweep	SVAR baseNameB=baseNameB	String retval=sprintf2sd("%s%d", baseNameB, iCurrentSweep)	SetDataFolder savedDFName	return retvalEndFunction UpdateTracesShowing(cbStruct) : CheckBoxControl	// This is called when the user checks/unchecks the "tr.A" or "tr.B" checkboxes in a	// DPBrowser window.  Currently, this automatically changes the DF state variables.	STRUCT WMCheckboxAction &cbStruct	if (cbStruct.eventCode!=2)		return 0							// we only handle mouse up in control	endif		Variable browserNumber=BrowserNumberFromName(cbStruct.win)		SyncBrowserViewToDFState(browserNumber)EndFunction RemoveBaseNamedWaves(base)	String base	String savDF, targetWindow, allwaves, thiswave	Variable i	savDF=GetDataFolder(1)	SetDataFolder root:	base+="*"	sprintf targetWindow, "WIN:"	allwaves=WaveList(base,";", targetWindow)	if (strlen(allwaves)>0)		i=0		do			thiswave=GetStrFromList(allwaves,i,";")			if (strlen(thiswave)==0)				break			else				RemoveFromGraph $thiswave			endif			i+=1		while(1)	endif	SetDataFolder savDFEndFunction UpdateRejectBox(browserNumber)	// Look at the wave notes for $traceAWaveName and $traceBWaveName, and update the	// Reject checkboxes to reflect their rejection-status 	Variable browserNumber	// Find name of top browser, switch the DF to its DF, note the former DF name	String savedDF=ChangeToBrowserDF(browserNumber)		// Update the traceAWaveName reject checkbox	String traceAWaveName=GetTraceAWaveNameAbs(browserNumber)	NVAR traceAChecked=traceAChecked	if ( traceAChecked && WaveExists($traceAWaveName) )		WAVE Wave1=$traceAWaveName		CheckBox reject1, value=GetWaveNoteNumber(Wave1,"REJECT")	endif		// Update the traceBWaveName reject checkbox	String traceBWaveName=GetTraceBWaveNameAbs(browserNumber)	NVAR traceBChecked=traceBChecked	if ( traceBChecked && WaveExists(traceBWaveName) )		WAVE Wave2=$traceBWaveName		CheckBox reject2, value=GetWaveNoteNumber(Wave2,"REJECT")	endif		// Restore the original DF	SetDataFolder savedDFEndFunction GetComments(browserNumber)	// Read the comments out of the currently-showing waves, and update the comments variable	// to update the comments text box.	Variable browserNumber	// Find name of top browser, switch the DF to its DF, note the former DF name	String savDF=ChangeToBrowserDF(browserNumber)	SVAR comments=comments	SVAR traceAWaveName=traceAWaveName	SVAR traceBWaveName=traceBWaveName	WAVE Wave1=$traceAWaveName	WAVE Wave2=$traceBWaveName	ControlInfo showTraceACheckbox	if ((V_value>0) && (exists(traceAWaveName)==1))		comments=GetWaveNoteString(Wave1,"COMMENTS")	else		ControlInfo showTraceBCheckbox		if ((V_value>0) && (exists(traceBWaveName)==1))			comments=GetWaveNoteString(Wave2,"COMMENTS")		endif	endif		// Restore the original DF	SetDataFolder savDFEndFunction RejectAccept(ctrlName,rejcheck) : CheckBoxControl	String ctrlName	Variable rejcheck	// Find name of top browser, switch the DF to its DF, note the former DF name	Variable browserNumber=GetTopBrowserNumber()	String savDF=ChangeToBrowserDF(browserNumber)	if (cmpstr(ctrlName,"reject1")==0)		SVAR wavename=traceAWaveName	else		SVAR wavename=traceBWaveName	endif	SetDataFolder root:	WriteWaveNote($wavename,"REJECT",num2str(rejcheck)+"\r")	SetDataFolder savDFEnd	Function BaseSub(cbStruct) : CheckBoxControl	// This is called when the user checks/unchecks one of the "Base Sub" checkboxes in a	// DPBrowser window.	STRUCT WMCheckboxAction &cbStruct	if (cbStruct.eventCode!=2)		return 0							// we only handle mouse up in control	endif		Variable browserNumber=BrowserNumberFromName(cbStruct.win)		SyncBrowserViewToDFState(browserNumber)EndFunction DoBaseSub(browserNumber)	// Perform baseline subtraction on $traceAWaveName and $traceBWaveName.	// Each wave's note says whether it has had the baseline subtracted, and also	// contains the baseline value for that wave.	Variable browserNumber		// Switch the DF, note the former DF name	String savedDFName=ChangeToBrowserDF(browserNumber)	// Get DF vars we need	NVAR traceAChecked=traceAChecked		String traceAWaveName=GetTraceAWaveNameAbs(browserNumber)	WAVE theWave=$traceAWaveName	Variable basesubtracted, baseline	if ( traceAChecked && WaveExists($traceAWaveName) )		baseline=GetWaveNoteNumber(theWave,"BASELINE")		basesubtracted=GetWaveNoteNumber(theWave,"BASESUBTRACTED")	endif	String traceBWaveName=GetTraceBWaveNameAbs(browserNumber)	ControlInfo basesub1	if ( (V_value>0) && WaveExists(traceBWaveName) )			// if baseline subtract is checked		 if (basesubtracted<1)							// but the baseline isn't subtracted			theWave -=  baseline							// subtract baseline			WriteWaveNote($traceAWaveName,"BASESUBTRACTED","1")	// and note baseline subtracted		endif	else												// if baseline subtract is not checked		 if (basesubtracted>0)							// but the baseline is subtracted			theWave +=  baseline							// add back the baseline			WriteWaveNote($traceAWaveName,"BASESUBTRACTED","0")	// and note baseline not subtracted		endif	endif	NVAR traceBChecked=traceBChecked	if ( traceBChecked && WaveExists(traceBWaveName) )		WAVE theWave=$traceBWaveName		baseline=GetWaveNoteNumber(theWave,"BASELINE")		basesubtracted=GetWaveNoteNumber(theWave,"BASESUBTRACTED")	endif	ControlInfo basesub2	if ( (V_value>0) && WaveExists(traceBWaveName) )				// if baseline subtract is checked		 if (basesubtracted<1)							// but the baseline isn't subtracted			theWave -=  baseline							// subtract baseline			WriteWaveNote(theWave,"BASESUBTRACTED","1")	// and note baseline subtracted		endif	else												// if baseline subtract is not checked		 if (basesubtracted>0)							// but the baseline is subtracted			theWave +=  baseline							// add back the baseline			WriteWaveNote(theWave,"BASESUBTRACTED","0")	// and note baseline not subtracted		endif	endif		// Restore the original DF.	SetDataFolder savedDFNameEndFunction GraphColors(thename, sweep, rval, gval, bval)	String thename	Variable sweep, rval, gval, bval	String thewave=thename+num2istr(sweep)	ModifyGraph rgb($thewave)=(rval,gval,bval)	ModifyGraph /Z grid(left)=1	ModifyGraph /Z tickUnit(bottom)=1	ModifyGraph /Z tickUnit(left)=1EndFunction SummonMeasurePanel(bStruct) : ButtonControl	STRUCT WMButtonAction &bStruct		if (bStruct.eventCode!=2)		return 0							// we only handle mouse up in control	endif	String browserName=bStruct.win;	Variable browserNumber=BrowserNumberFromName(browserName);	PauseUpdate; Silent 1		// building window...	String measurePanelName=sprintf1d("MeasurePanel%d",browserNumber)	if (PanelExists(measurePanelName))		DoWindow /F $measurePanelName	else		String createPanel		sprintf createPanel "MeasurePanel(%d)" browserNumber		Execute createPanel	endif	UpdateMeasurements(browserNumber)EndFunction SummonToolsPanel(bStruct) : ButtonControl	STRUCT WMButtonAction &bStruct		if (bStruct.eventCode!=2)		return 0							// we only handle mouse up in control	endif	String browserName=bStruct.win;	Variable browserNumber=BrowserNumberFromName(browserName);	PauseUpdate; Silent 1		// building window...	String toolsPanelName=sprintf1d("ToolsPanel%d",browserNumber)	if (PanelExists(toolsPanelName))		DoWindow /F $toolsPanelName	else		String createPanel		sprintf createPanel "ToolsPanel(%d)" browserNumber		Execute createPanel	endif	//UpdateTools(browserNumber)EndFunction ShowHideToolsPanel(cbStruct) : CheckboxControl	// This is called when the user checks/unchecks the "Show tools" checkbox in a	// DPBrowser window.	STRUCT WMCheckboxAction &cbStruct	if (cbStruct.eventCode!=2)		return 0							// we only handle mouse up in control	endif		Variable browserNumber=BrowserNumberFromName(cbStruct.win)	SyncBrowserViewToDFState(browserNumber)End//Function AverageOld(ctrlName) : ButtonControl//	String ctrlName//	PauseUpdate; Silent 1		// building window...//	String createpanel//	createpanel="AveragePanel()"//	if (wintype("AveragePanel")!=7)//		Execute createpanel//	else//		DoWindow /F AveragePanel//	endif//	DoWindow /F DataBrowser//EndFunction SummonFitPanel(bStruct) : ButtonControl	STRUCT WMButtonAction &bStruct		if (bStruct.eventCode!=2)		return 0							// we only handle mouse up in control	endif	String browserName=bStruct.win;	Variable browserNumber=BrowserNumberFromName(browserName);	PauseUpdate; Silent 1		// building window...	String fitPanelName=FitPanelNameFromNumber(browserNumber)	if (PanelExists(fitPanelName))		DoWindow /F $fitPanelName	else		String commandString=sprintf1d("FitPanel(%d)",browserNumber)		Execute commandString	endifEndFunction SummonAveragePanel(bStruct) : ButtonControl	STRUCT WMButtonAction &bStruct		if (bStruct.eventCode!=2)		return 0							// we only handle mouse up in control	endif	String browserName=bStruct.win;	Variable browserNumber=BrowserNumberFromName(browserName);	PauseUpdate; Silent 1		// building window...	String averagePanelName=AveragePanelNameFromNumber(browserNumber)	if (PanelExists(averagePanelName))		DoWindow /F $averagePanelName	else		String commandString=sprintf1d("AveragePanel(%d)",browserNumber)		Execute commandString	endifEndFunction UpdateMeasurementsAndFit(browserNumber)	Variable browserNumber  // the index of the DP browser instance	UpdateMeasurements(browserNumber)	UpdateFit(browserNumber)EndFunction UpdateMeasurements(browserNumber)	// Updates the values displayed in the Measure part of the Tools Panel to reflect the wave 	// currently displayed in	// the DP Browser, given the current measurement parameters in the DF.	// This is essentially syncing the measured values (part of the model) to the rest of the model 	// (containing the waves and the measurement cursor positions).  The bindings between the 	// measured values and the various controls in the Measure panel view take care of updating the	// view to reflect the altered model.	Variable browserNumber  // the index of the DP browser instance		// Save the current data folder, change to this browser's DF	String savedDF=ChangeToBrowserDF(browserNumber)		// Get references to all the variables that we need in this data folder	NVAR hold1=hold1, step1=step1, hold2=hold2, step2=step2	NVAR tBaselineLeft=tBaselineLeft, tBaselineRight=tBaselineRight	NVAR tWindow1Left=tWindow1Left, tWindow1Right=tWindow1Right	NVAR tWindow2Left=tWindow2Left, tWindow2Right=tWindow2Right	//SVAR traceAWaveName=traceAWaveName	//SVAR traceBWaveName=traceBWaveName	//SVAR topTraceWaveName=topTraceWaveName	SVAR comments=comments	NVAR to1, from1	NVAR to2, from2	NVAR base, mean1, peak1, rise1	NVAR mean2, peak2, rise2	NVAR lev1, cross1			// If there's a top wave, calculate features of it	String topTraceWaveName=GetTopTraceWaveNameAbs(browserNumber)	if (strlen(topTraceWaveName)>0)		// Calculate the baseline		WAVE thisWave=$topTraceWaveName		if ( IsFinite(tBaselineLeft) && IsFinite(tBaselineRight) )			base=mean($topTraceWaveName,tBaselineLeft,tBaselineRight)		else			base=NaN		endif				// Calculate features of window 1		if ( IsFinite(tWindow1Left) && IsFinite(tWindow1Right) )			WaveStats /Q/R=(tWindow1Left,tWindow1Right) thisWave			mean1=V_avg-base			if (abs(V_min-base)>abs(V_max-base))				peak1=V_min-base			else				peak1=V_max-base				endif			rise1=RiseTime(thisWave,tWindow1Left,tWindow1Right,base,peak1,from1/100,to1/100)			cross1=CountThresholdCrossings(thisWave, tWindow1Left, tWindow1Right, lev1)		else			mean1=NaN			peak1=NaN			rise1=NaN		endif				// Calculate features of window 2		if ( IsFinite(tWindow2Left) && IsFinite(tWindow2Right) )			WaveStats /Q/R=(tWindow2Left,tWindow2Right) thisWave			mean2=V_avg-base			if (abs(V_min-base)>abs(V_max-base))				peak2=V_min-base			else				peak2=V_max-base					endif			rise2=RiseTime(thisWave,tWindow2Left,tWindow2Right,base,peak2,from2/100,to2/100)		else			mean2=NaN			peak2=NaN			rise2=NaN		endif	endif		// Restore the original data folder	SetDataFolder savedDFEndFunction SetBaseline(bStruct) : ButtonControl	STRUCT WMButtonAction &bStruct		// Check that this is really a button-up on the button	if (bStruct.eventCode!=2)		return 0							// we only handle mouse up in control	endif		// Get the browser number from the bStruct	String measurePanelName=bStruct.win;	Variable browserNumber=BrowserNumberFromName(measurePanelName);	// Check that the cursors are actually set, otherwise return	String browserName=BrowserNameFromNumber(browserNumber)	if (!AreCursorsAAndBSet(browserName))		return nan	endif		// Save the current data folder, change to this browser's DF	String savedDF=ChangeToBrowserDF(browserNumber)	// Set limits of the baseline window	NVAR tBaselineLeft=tBaselineLeft		tBaselineLeft=xcsr(A,browserName)  // times of left and right cursor that delineate the baseline region	NVAR tBaselineRight=tBaselineRight	tBaselineRight=xcsr(B,browserName)		// Update the view	SyncBrowserViewToDFState(browserNumber)		// Restore the orignal DF	SetDataFolder savedDF	EndFunction ClearBaseline(bStruct) : ButtonControl	STRUCT WMButtonAction &bStruct		// Check that this is really a button-up on the button	if (bStruct.eventCode!=2)		return 0							// we only handle mouse up in control	endif		// Get the browser number from the bStruct	String measurePanelName=bStruct.win;	Variable browserNumber=BrowserNumberFromName(measurePanelName);		// Save the current data folder, change to this browser's DF	String savedDF=ChangeToBrowserDF(browserNumber)	// Clear limits of the baseline window	NVAR tBaselineLeft	NVAR tBaselineRight	tBaselineLeft=nan	tBaselineRight=nan		// Update the view	SyncBrowserViewToDFState(browserNumber)		// Restore the orignal DF	SetDataFolder savedDF	EndFunction AddCursorLineToGraph(graphName,cursorWaveName,tCursor,r,g,b)	// Adds a wave to the named graph that represents a cursor position.	String graphName  // the name of the graph to add the cursor line to	String cursorWaveName  // what to name the wave that is the cursor	Variable tCursor // the time at which to place the cursor	Variable r,g,b  // the color		// Go through a lot of trouble to find the y span of the cursor		SVAR baseNameA=baseNameA	SVAR baseNameB=baseNameB	NVAR iCurrentSweep=iCurrentSweep			// Get the max and min of wave A trace	String traceAWaveName=sprintf2sd("root:%s%d", baseNameA, iCurrentSweep)	Variable waveAExists=WaveExists($traceAWaveName)	Variable yAMin, yAMax	if (waveAExists)		WaveStats /Q $traceAWaveName		yAMax=V_max		yAMin=V_min	else		yAMin=+inf		yAMax=-inf	endif	// Get the max and min of wave B trace	String traceBWaveName=sprintf2sd("root:%s%d", baseNameB, iCurrentSweep)	Variable waveBExists=WaveExists($traceBWaveName)			Variable yBMin, yBMax	if (waveBExists)		WaveStats /Q $traceBWaveName		yBMax=V_max		yBMin=V_min	else		yBMin=+inf		yBMax=-inf	endif				// Get the overall yMin, yMax	Variable yMin=min(yAMin,yBMin)	Variable yMax=max(yAMax,yBMax)		if (NumType(yMin)!=0)  // is yMin a normal number (non-inf)?		yMin=-1	endif	if (NumType(yMax)!=0)  // is yMax a normal number (non-inf)?		yMax=+1	endif		// Now that yMin and yMax are determined, draw the cursors	Make /O /N=2 $cursorWaveName ={yMin,yMax}	Setscale /I x, tCursor, tCursor+1e-6, "ms", $cursorWaveName	String windowSpec=sprintf1s("WIN:%s",graphName)	SVAR cursorWaveList=cursorWaveList	if (ItemsInList(WaveList(cursorWaveName,";",windowSpec))>0)		RemoveFromGraph /W=$graphName $cursorWaveName  // remove if already present		cursorWaveList=RemoveFromList(cursorWaveName,cursorWaveList)	endif	AppendToGraph /W=$graphName /C=(r,g,b) $cursorWaveName	cursorWaveList=AddListItem(cursorWaveName,cursorWaveList)EndFunction SetWindow1(bStruct)	STRUCT WMButtonAction &bStruct		// Check that this is really a button-up on the button	if (bStruct.eventCode!=2)		return 0							// we only handle mouse up in control	endif	// Get the browser number	String measurePanelName=bStruct.win;	Variable browserNumber=BrowserNumberFromName(measurePanelName)	// Check that the cursors are actually set, otherwise return	String browserName=BrowserNameFromNumber(browserNumber)	if (!AreCursorsAAndBSet(browserName))		return nan	endif	// Save the current data folder, change to this browser's DF	String savedDF=ChangeToBrowserDF(browserNumber)	// Set up aliases depending on nDataWindow		NVAR tWindow1Left, tWindow1Right		// Draw vertical lines to indicate the margins of the window time range	tWindow1Left=xcsr(A,browserName)  // times of left and right cursor that delineate the window region	tWindow1Right=xcsr(B,browserName)	// Update the view	SyncBrowserViewToDFState(browserNumber)	// Restore the orignal DF	SetDataFolder savedDF	EndFunction ClearWindow1(bStruct) : ButtonControl	STRUCT WMButtonAction &bStruct		// Check that this is really a button-up on the button	if (bStruct.eventCode!=2)		return 0							// we only handle mouse up in control	endif		// Get the browser number from the bStruct	String measurePanelName=bStruct.win;	Variable browserNumber=BrowserNumberFromName(measurePanelName);		// Save the current data folder, change to this browser's DF	String savedDF=ChangeToBrowserDF(browserNumber)	// Clear limits of the window	NVAR tWindow1Left	NVAR tWindow1Right	tWindow1Left=nan	tWindow1Right=nan		// Update the view	SyncBrowserViewToDFState(browserNumber)		// Restore the orignal DF	SetDataFolder savedDF	EndFunction SetWindow2(bStruct)	STRUCT WMButtonAction &bStruct		// Check that this is really a button-up on the button	if (bStruct.eventCode!=2)		return 0							// we only handle mouse up in control	endif	// Get the browser number	String measurePanelName=bStruct.win;	Variable browserNumber=BrowserNumberFromName(measurePanelName)	// Check that the cursors are actually set, otherwise return	String browserName=BrowserNameFromNumber(browserNumber)	if (!AreCursorsAAndBSet(browserName))		return nan	endif	// Save the current data folder, change to this browser's DF	String savedDF=ChangeToBrowserDF(browserNumber)	// Set up aliases depending on nDataWindow		NVAR tWindow2Left, tWindow2Right		// Draw vertical lines to indicate the margins of the window time range	tWindow2Left=xcsr(A,browserName)  // times of left and right cursor that delineate the window region	tWindow2Right=xcsr(B,browserName)	// Update the view	SyncBrowserViewToDFState(browserNumber)	// Restore the orignal DF	SetDataFolder savedDF	EndFunction ClearWindow2(bStruct) : ButtonControl	STRUCT WMButtonAction &bStruct		// Check that this is really a button-up on the button	if (bStruct.eventCode!=2)		return 0							// we only handle mouse up in control	endif		// Get the browser number from the bStruct	String measurePanelName=bStruct.win;	Variable browserNumber=BrowserNumberFromName(measurePanelName);		// Save the current data folder, change to this browser's DF	String savedDF=ChangeToBrowserDF(browserNumber)	// Clear limits of the window	NVAR tWindow2Left	NVAR tWindow2Right	tWindow2Left=nan	tWindow2Right=nan		// Update the view	SyncBrowserViewToDFState(browserNumber)		// Restore the orignal DF	SetDataFolder savedDF	EndFunction UpdateRise(svStruct) : SetVariableControl	// Called when the user changes the sweep number in the DPBrowser, 	// which first changes iCurrentSweep.	STRUCT WMSetVariableAction &svStruct		if ( svStruct.eventCode==-1 ) 		return 0	endif		String browserName=svStruct.win	Variable browserNumber=BrowserNumberFromName(browserName)	UpdateMeasurements(browserNumber)	EndFunction RiseTime(thisWave,tLeft,tRight,yBase,dyPeak,fracFrom,fracTo)	Wave thisWave	Variable tLeft,tRight, yBase, dyPeak, fracFrom, fracTo	Variable yFrom=yBase+fracFrom*dyPeak	FindLevel /Q/R=(tLeft,tRight) thisWave, yFrom  // find level crossing	Variable tFrom= (V_flag==0) ? V_LevelX : NaN	Variable yTo=yBase+fracTo*dyPeak	FindLevel /Q/R=(tLeft,tRight) thisWave, yTo  // find level crossing	Variable tTo= (V_flag==0) ? V_LevelX : NaN	Variable tRise=tTo-tFrom	return tRiseEndFunction UpdateLevels(svStruct) : SetVariableControl	// Called when the user changes the sweep number in the DPBrowser, 	// which first changes iCurrentSweep.	STRUCT WMSetVariableAction &svStruct		if ( svStruct.eventCode!=2 && svStruct.eventCode!=3 && svStruct.eventCode!=6 ) 		return 0	endif		// Save the current data folder, change to this browser's DF	Variable browserNumber=BrowserNumberFromName(svStruct.win)	String savedDF=ChangeToBrowserDF(browserNumber)	// Count the number of threshold crossings, set the model variable	SVAR topTraceWaveName=topTraceWaveName	NVAR tWindow1Left=tWindow1Left, tWindow1Right=tWindow1Right	NVAR lev1=lev1	NVAR cross1=cross1	cross1=CountThresholdCrossings($topTraceWaveName, tWindow1Left, tWindow1Right, lev1)	// Restore the original data folder	SetDataFolder savedDF	EndFunction CountThresholdCrossings(theWave, tWindowLeft, tWindowRight, threshold)	Wave theWave	Variable tWindowLeft, tWindowRight, threshold	if (threshold!=threshold)  // true iff threshold is nan		return nan	endif	FindLevels /Q/R=(tWindowLeft,tWindowRight) theWave, threshold	return V_LevelsFoundEndFunction DoAverage(bStruct) : ButtonControl	STRUCT WMButtonAction &bStruct		// Check that this is really a button-up on the button	if (bStruct.eventCode!=2)		return 0							// we only handle mouse up in control	endif	// Don't update graphs, don't echo to transcript		PauseUpdate; Silent 1		// Get the browser number from the bStruct	Variable browserNumber=BrowserNumberFromName(bStruct.win);				// Save the current DF, set the data folder to the appropriate one for this DataProBrowser instance	String savedDFName=ChangeToBrowserDF(browserNumber)		// Determine the range of sweeps we're going to average	String browserName=BrowserNameFromNumber(browserNumber)	Controlinfo /W=$browserName showTraceACheckbox	Variable channel1Showing=V_value	Controlinfo /W=$browserName showTraceBCheckbox	Variable channel2Showing=V_value	String averagePanelName=AveragePanelNameFromNumber(browserNumber)	ControlInfo /W=$averagePanelName range_all	Variable averageAllSweeps=V_value		SVAR baseNameA=baseNameA	SVAR baseNameB=baseNameB	Variable iFrom, iTo	if (averageAllSweeps)		iFrom=1		iTo=0		if (channel1Showing)			iTo=max(iTo,NTracesFromBaseName(baseNameA))		endif		if (channel2Showing)			iTo=max(iTo,NTracesFromBaseName(baseNameB))		endif	else		NVAR avgto=avgto		NVAR avgfrom=avgfrom		iFrom=avgfrom		iTo=avgto	endif		// Mark each possibly-eligible wave with a note saying whether to include it	// in the average or not, then do the average	SVAR baseNameA=baseNameA, baseNameB=baseNameB	NVAR holdCenter=avghold	NVAR holdTol=holdtolerance, stepCenter=avgstep	ControlInfo /W=AveragePanel hold_all	Variable filterOnHold=!V_value	ControlInfo /W=AveragePanel step_all	Variable filterOnStep=!V_value	//SetDataFolder root:	Variable i	String waveNameThis;	if (channel1Showing)		for (i=iFrom; i<=iTo; i+=1)			waveNameThis=sprintf2sd("root:%s%d", baseNameA, i)			MarkWaveForAveraging(waveNameThis,filterOnHold,holdCenter,holdTol,filterOnStep,stepCenter)		endfor		AvgLoop(browserNumber,baseNameA,iFrom,iTo)	endif				if (channel2Showing)		for (i=iFrom; i<=iTo; i+=1)			waveNameThis=sprintf2sd("root:%s%d", baseNameB, i)			MarkWaveForAveraging(waveNameThis,filterOnHold,holdCenter,holdTol,filterOnStep,stepCenter)		endfor		AvgLoop(browserNumber,baseNameB,iFrom,iTo)	endif					// Restore original DF	SetDataFolder savedDFNameEndFunction AvgLoop(browserNumber,waveBaseName, iFrom, iTo)	Variable browserNumber	String waveBaseName	Variable iFrom, iTo	// Figure the dest wave name, increment the next sweep index for acquisition		NVAR acqNextSweepIndex=root:DP_ADCDACcontrol:wavenumber	String destWaveName = sprintf2sd("root:%s%d", waveBaseName, acqNextSweepIndex)	acqNextSweepIndex+=1		// Loop over waves to be averaged, forming the sum and counting the number of waves	Variable i, dontavg, nWavesToAvg=0	NVAR avgstep=avgstep	for (i=iFrom; i<=iTo; i+=1)		String thisWaveName=sprintf2sd("root:%s%d", waveBaseName, i)		WAVE thisWave=$thisWaveName		dontavg=GetWaveNoteNumber(thisWave,"DONTAVG")		if (!dontavg)			if (nWavesToAvg==0)				Duplicate /O thisWave $destWaveName				WAVE outWave=$destWaveName				Note /K outWave				WriteWaveNote(outWave,"WAVETYPE","average")				WriteWaveNote(outWave,"TIME",time())				WriteWaveNote(outWave,"DONTAVG","1")				WriteWaveNote(outWave,"STEP",num2str(avgstep)+"\r")				outwave = 0			endif			outWave += thisWave			nWavesToAvg += 1		endif	endfor		// Actually compute the average from the sum	String waveBaseNameShort=RemoveEnding(waveBaseName,"_")	if (nWavesToAvg>0)		outWave /= nWavesToAvg	else		String message=sprintf1s("%s: No waves met your criteria to be averaged.", waveBaseNameShort)		Abort message	endif	Printf "%s: %d waves were averaged and stored in %s\r", waveBaseNameShort, nWavesToAvg, destWaveName		// Save the average wave to disk, if called for	String windowName=AveragePanelNameFromNumber(browserNumber)	ControlInfo /W=$windowName saveavg		if (V_value>0)		String outFileName=sprintf1s("%s.avg", destWaveName)		Save /C/I outWave as outFileName		Printf "%s: Average saved to disk as %s\r", waveBaseNameShort, outFileName	else		Printf "%s: Average not saved to disk\r", waveBaseNameShort	endifEnd//Proc AvgOutName(outwave, avgprompt)//	String outwave, avgprompt//	Prompt outwave, avgprompt//	destwave=outwave//EndFunction SetFitZero(bStruct) : ButtonControl	STRUCT WMButtonAction &bStruct		// Check that this is really a button-up on the button	if (bStruct.eventCode!=2)		return 0							// we only handle mouse up in control	endif		// Get the browser number from the bStruct	Variable browserNumber=BrowserNumberFromName(bStruct.win);		// Check that the cursors are actually set, otherwise return	String browserName=BrowserNameFromNumber(browserNumber)	if (!IsCursorASet(browserName))		return nan	endif		// Save the current DF, set the data folder to the appropriate one for this DataProBrowser instance	String savedDFName=ChangeToBrowserDF(browserNumber)	// Draw vertical line to indicate the cursor	NVAR tFitZero=tFitZero	tFitZero=xcsr(A,browserName)	//SVAR traceAWaveName=traceAWaveName  // actually the name of a wave, not the wave itself	//AddCursorLineToGraph(browserName,"fitLineZero",tFitZero)	//ModifyGraph rgb(fitLineZero)=(26411,1,52428)	// Update the view	SyncBrowserViewToDFState(browserNumber)		// Restore original DF	SetDataFolder savedDFNameEndFunction SetFitRange(bStruct) : ButtonControl	STRUCT WMButtonAction &bStruct		// Check that this is really a button-up on the button	if (bStruct.eventCode!=2)		return 0							// we only handle mouse up in control	endif		// Get the browser number from the bStruct	Variable browserNumber=BrowserNumberFromName(bStruct.win);		// Check that the cursors are actually set, otherwise return	String browserName=BrowserNameFromNumber(browserNumber)	if (!AreCursorsAAndBSet(browserName))		return nan	endif		// Save the current DF, set the data folder to the appropriate one for this DataProBrowser instance	String savedDFName=ChangeToBrowserDF(browserNumber)	// Draw vertical line to indicate the cursor	NVAR tFitLeft=tFitLeft	tFitLeft=xcsr(A,browserName)	NVAR tFitRight=tFitRight	tFitRight=xcsr(B,browserName)	//SVAR traceAWaveName=traceAWaveName  // actually the name of a wave, not the wave itself	//AddCursorLineToGraph(browserName,"fitLineLeft",tFitLeft)	//AddCursorLineToGraph(browserName,"fitLineRight",tFitRight)	//ModifyGraph rgb(fitLineLeft)=(0,65535,65535)	//ModifyGraph rgb(fitLineRight)=(0,65535,65535)	// Update the view	SyncBrowserViewToDFState(browserNumber)		// Restore original DF	SetDataFolder savedDFNameEndFunction DoFit(bStruct) : ButtonControl	STRUCT WMButtonAction &bStruct		// Check that this is really a button-up on the button	if (bStruct.eventCode!=2)		return 0							// we only handle mouse up in control	endif		// Get the browser number from the bStruct	Variable browserNumber=BrowserNumberFromName(bStruct.win);		// Sync the view to the model	SyncBrowserViewToDFState(browserNumber)EndFunction UpdateFit(browserNumber)	Variable browserNumber		// Save the current DF, set the data folder to the appropriate one for this DataProBrowser instance	String savedDFName=ChangeToBrowserDF(browserNumber)	// Get the DF vars we'll need	//SVAR traceAWaveName=traceAWaveName	NVAR tFitZero=tFitZero	NVAR tFitLeft=tFitLeft	NVAR tFitRight=tFitRight	// If the offset to be held fixed?  To what value?	NVAR holdYOffset=holdYOffset  // boolean	NVAR yOffsetHold=yOffsetHold	// The fit parameters	NVAR yOffset=yOffset, amp1=amp1, tau1=tau1, amp2=amp2, tau2=tau2	// Enable/disable the yOffset hold SetVariable control	String panelName=ToolsPanelNameFromNumber(browserNumber)	if (holdYOffset)		SetVariable yOffsetHoldControl,win=$panelName,disable=0	else		SetVariable yOffsetHoldControl,win=$panelName,disable=2	endif	// See if everything is set up to do a fit.  If not, return.	String topTraceWaveName=GetTopTraceWaveNameAbs(browserNumber)	if ( strlen(topTraceWaveName)==0 || IsNan(tFitZero) || IsNan(tFitLeft) || IsNan(tFitRight) )		return nan	endif		// Make a new wave, fitWave, that's a copy of $traceAWaveName with the time base shifted 	// to put tFitZero at t==0	Duplicate /O $topTraceWaveName fitWave	Variable tLeftShifted=leftx($topTraceWaveName)-tFitZero	Variable tRightShifted=rightx($topTraceWaveName)-tFitZero	Setscale x, tLeftShifted,tRightShifted, "ms", fitWave	// Are we doing single or double exponential fit?	ControlInfo /W=$panelName fit_function	Variable singleExp=AreStringsEqual(S_value,"single exp")	// Build up the command to do the fit, keeping it in the string commandString	String commandString="CurveFit /N "	// Specify coefficients to be held fixed	if (singleExp)		if (holdYOffset)			commandString+="/H=\"100\" "		endif	else		if (holdYOffset)			commandString+="/H=\"10000\" "		endif	endif	// Specify single- or double-exponential fit	if (singleExp)		commandString += "exp, "	else			commandString += "dblexp, "	endif	// specify an explicit wave of coeffs, used both for reading values to be held fixed, and	// for outputing the final fit coeffs	if (singleExp) 		Make /O/N=3 coeffs 	else 		Make /O/N=5 coeffs 	endif	if (holdYOffset)		coeffs[0]=yOffsetHold	endif	commandString+="kwCWave=coeffs "		commandString+="fitWave(tFitLeft-tFitZero,tFitRight-tFitZero)"		// Execute the command to do the fit, unpack the coefficients into DP Browser vars	Execute commandString	yOffset=coeffs[0]	amp1=coeffs[1]	tau1=1/coeffs[2]	if (singleExp)		amp2=nan		tau2=nan	else		amp2=coeffs[3]		tau2=1/coeffs[4]	endif		// Make a wave, yFit, containing the fit curve	Make /O /N=500 yFit	NVAR dtFitExtend=dtFitExtend	Setscale /I x, tFitZero, tFitRight+dtFitExtend, "ms", yFit	if (singleExp)		yFit= yOffset+amp1*exp(-(x-tFitZero)/tau1)	else		yFit= yOffset+amp1*exp(-(x-tFitZero)/tau1)+amp2*exp(-(x-tFitZero)/tau2)	endif	// Add the fit wave to the DP Browser window	String browserName=BrowserNameFromNumber(browserNumber)	String windowSpec=sprintf1s("WIN:%s",browserName)	if (ItemsInList(WaveList("yFit",";",windowSpec))>0)		RemoveFromGraph yFit  // remove if already present	endif	AppendToGraph yFit	// Restore original DF	SetDataFolder savedDFNameEndProc DataBrowser_Help()	String AbortMessage	AbortMessage="To get help, open the 'DataBrowser_Help' file (as a help file) or "	AbortMessage+= "double click on the icon in the finder.  After doing so, 'DataBrowser_Help' "	AbortMessage+= "will appear under 'Help Windows' in the Igor 'Windows' pulldown"	Abort AbortMessageEnd//-------------------------USEFUL ANALYSIS UTILITIES-------------------------//Proc SetDataUnits(match,units)	String match, units	String list, command	list=Wavelist(match,",","")	sprintf command "SetScale d 0,0,\"%s\" %s", units, list	print command	Execute commandEndProc GetRidofGraphAxes()	ModifyGraph noLabel=2,axThick=0EndProc DisplaySeries(name,first,n,left,top,right,bottom)	String name, wave	Variable first=0, n=1, left=0, top=0, right=700, bottom=500	iterate(n)		sprintf wave "%s%d", name, first+i		if (i==0)			Display /W=(left,top,right,bottom) $wave			PauseUpdate		else			Append $wave		endif	loop	Modify rgb=(0,0,0)	Modify axThick=0	Modify noLabel=2	Modify lsize=0.7EndProc KillWindows()	Silent 1	String name, list	String win	Variable index=0	list = Winlist("*",";","WIN:7")	do		| get the next window		win = GetStrFromList(list, index, ";")		if (strlen(win) == 0)			break		else			DoWindow /K $win		endif		index += 1	while (1) | loop until break aboveEndProc KillWavesWithName(name)	String name, list, match	Silent 1	String wave	Variable index=0	sprintf match "%s*", name	list = Wavelist(match,";","")	do		| get the next wave		wave = GetStrFromList(list, index, ";")		if (strlen(wave) == 0)			break		else			KillWaves $wave		endif		index += 1	while (1) | loop until break aboveEndFunction Inflection(wave,level,left,right)//	Finds inflection point of a wave	String wave	Variable level, left, right	String diff	sprintf diff, "diff_%s", wave[0]	Duplicate /O $wave $diff	Smooth/S=4/E=3 7, $diff	Differentiate $diff	FindLevel /Q/R=(left,right) $diff, level	return V_LevelXEndFunction niceround(x)	Variable x	do		if (x<5)			x=round(x)			break		endif		if (x<10)			x=round(x/5)*5			break		endif		if (x<50)			x=round(x/10)*10			break		endif		if (x<100)			x=round(x/25)*25			break		endif		if (x<250)			x=round(x/50)*50			break		else			x=round(x/100)*100		endif	while(0)	return xEnd//-----------------------Calibrator from Wavemetrics------------------------//Function InitCalibratorGlobals()	String/G u_xaxis="bottom",u_yaxis="left"	Variable/G/D u_dx=1,u_dy=1	Variable/G u_orient=3,u_label=3	// lower-left, print with unitsEndProc Calibrator()	if (exists("u_xaxis")<2)		InitCalibratorGlobals()	endif	WMCalibrator()EndProc WMCalibrator(xaxis,yaxis,dx,dy,orient,label)	String xaxis=u_xaxis, yaxis=u_yaxis	Variable/D dx=u_dx,dy=u_dy	Variable orient=u_orient,label=u_label	Prompt xaxis,"X axis (horizontal axis)",popup,HVAxisList("",1)	//  only horizontal axes	Prompt yaxis,"Y axis (vertical axis)",popup,HVAxisList("",0)	//  only vertical axes	Prompt dx,"calibrator X length, or 0 for none"	Prompt dy,"calibrator Y length, or 0 for none"	Prompt orient,"Orientation",popup,"upper-left;upper-right;lower-right;lower left;"	Prompt label,"print values",popup,"donÕt print;print;print with units;print with units and ,K,m,µ etc"		PauseUpdate;Silent 1	u_xaxis=xaxis;u_yaxis=yaxis	u_dx=dx;u_dy=dy	u_orient=orient;u_label=label		FCalibrator(xaxis,yaxis,dx,dy,orient,label)End// Replace "Function" with "Macro" to reduce compile timeFunction FCalibrator(xaxis,yaxis,dx,dy,orient,label)	String xaxis,yaxis	Variable/D dx,dy	Variable orient,label	// see popup list of Calibrator macro for label values (1 is don't print, etc)		// Put calibrator in upper right corner of graph	Variable/D xorig,yorig	// corner of calibrator	Variable/D px,py		// polygon origin	Variable/D hx,hy,vx,vy	// text origins	Variable/D sf=0.15		// inset from upper-right corner	GetAxis/Q $xaxis;xorig=V_max-(V_max-V_min)*sf	GetAxis/Q $yaxis;yorig=V_max-(V_max-V_min)*sf	GraphNormal			// Forces deselection	SetDrawEnv gstart		// gstart can't be on next line!	SetDrawEnv xcoord= $xaxis,ycoord= $yaxis, fillpat=0,linethick=2, linefgc=(0,0,0)	if(orient == 1) // upper-left		xorig -= dx		hx= xorig + dx/2		vy= yorig - dy/2		px= xorig;py=yorig-dy		DrawPoly px,py, 1, 1, {0,0,0,dy,dx,dy}	endif	if(orient == 2) // upper-right		hx= xorig - dx/2		vy= yorig - dy/2		px= xorig-dx;py=yorig		DrawPoly px,py, 1, 1, {0,0,dx,0,dx,-dy}	endif	if(orient == 3) // lower-right		yorig -= dy		hx= xorig - dx/2		vy= yorig + dy/2		px= xorig;py=yorig+dy		DrawPoly px,py, 1, 1, {0,0,0,-dy,-dx,-dy}	endif	if(orient == 4) // lower left		xorig -= dx		yorig -= dy		hx= xorig + dx/2		vy= yorig + dy/2		px= xorig+dx;py=yorig		DrawPoly px,py, 1, 1, {0,0,-dx,0,-dx,dy}	endif	String labelVal,fmt,units	// horizontal calibrator value	if( (dx != 0)%& (label>1) )		// label == 1 is don't print		units= AxisUnits(xaxis)		fmt="%g"		if( (label== 3) %& (strlen(units)>0) )	// 3 is print with units			fmt += " "+units		endif		if(label == 4)				// 4 is print with units and prefixes			fmt="%.1W1P"+units	// change %.1 to number of digits after decimal point you want (%.2 is two digits, etc)		endif		sprintf labelVal, fmt, dx		hy = yorig-(0.1*dy)		Variable yj=0	// bottom		if( orient >= 3 )			yj= 2		// top		endif		SetDrawEnv xcoord= $xaxis,ycoord= $yaxis,textxjust=1,textyjust=yj		DrawText hx,hy, labelVal	endif	// vertical calibrator value	if( (dy != 0)%& (label>1) )		units= AxisUnits(yaxis)		fmt="%g"		if( (label== 3) %& (strlen(units)>0) )			fmt += " "+units		endif		if(label == 4)			fmt="%.1W1P"+units		endif		sprintf labelVal, fmt, dy		vx= xorig+(0.1*dx)		Variable xj=0,rot=0					// left	| use rot= -90 for top-to-bottom		if( (orient == 1) %| (orient == 4) )	// "upper-left; upper-right;lower-right;lower left;"			xj= 0								// right use rot=90 for bottom-to-top		endif		SetDrawEnv xcoord= $xaxis,ycoord= $yaxis,textxjust= xj,textyjust=1,textrot=rot		DrawText vx,vy, " "+labelVal+" "	// extra spaces to keep label away from line	endif	SetDrawEnv gstopEndFunction CountItemsInList(theList)        String theList        Variable i=0        do                if (strlen(GetStrFromList(theList, i, ";")) == 0)                        break                endif                i += 1        while(1)        return iendFunction CountWaves(BaseStr)       String BaseStr 	return CountItemsInList(GetSweepList(BaseStr))endFunction /S GetSweepList(BaseStr)	String BaseStr	String SweepList	String firstList, item, back       Variable xx, i	firstList = WaveList(BaseStr+"*", ";","")//	removes all items from the list that do not have the form BaseStr+number      SweepList = ""      i =0      	do       	item = GetStrFromList(firstList, i, ";")		if (strlen(item) == 0)                        break              else			xx = str2num(item[strlen(BaseStr),99])			back = BaseStr+num2str(xx)			if (abs(cmpstr(item,back))<1)				SweepList += item+";"			endif		endif		i += 1	while(1)	return SweepListEndFunction SetStepVarProc(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	String command	NVAR iCurrentSweep=iCurrentSweep	sprintf command, "SetStepValue(\"%s\",%d,%d)", varName, iCurrentSweep, varNum	Execute commandEndProc SetStepValue(whichstep, whichsweep, stepval)	String whichstep	Variable whichsweep, stepval	String wavestr	if (cmpstr(whichstep,"step1")<1)		sprintf wavestr, "%s%d", baseNameA, whichsweep		WriteWaveNote($wavestr,"STEP",num2str(stepval))	endif	if (cmpstr(whichstep,"step2")<1)		sprintf wavestr, "%s%d", baseNameB, whichsweep		WriteWaveNote($wavestr,"STEP",num2str(stepval))	endif	if (cmpstr(whichstep,"step3")<1)		sprintf wavestr, "%s%d", baseNameA, whichsweep		WriteWaveNote($wavestr,"STEP",num2str(stepval))		sprintf wavestr, "%s%d", baseNameB, whichsweep		WriteWaveNote($wavestr,"STEP",num2str(stepval))	endifEndFunction HandleHoldYOffsetCheckbox(cbStruct) : CheckBoxControl	STRUCT WMCheckboxAction &cbStruct		// If event is other than mouse up within control, do nothing	if (cbStruct.eventCode!=2)		return 0	endif	// Find name of browser, switch the DF to its DF, note the former DF name	Variable browserNumber=BrowserNumberFromName(cbStruct.win)	String savedDFName=ChangeToBrowserDF(browserNumber)	// If the checkbox has just been checked, and if the curent hold value is nan, 	// and the current y offset is _not_ nan, copy the y offset into the hold value	NVAR holdYOffset=holdYOffset	NVAR yOffsetHold=yOffsetHold	NVAR yOffset=yOffset	if ( holdYOffset && IsNan(yOffsetHold) && !IsNan(yOffset) )		yOffsetHold=yOffset	endif	// Sync the the view with the current state	SyncBrowserViewToDFState(browserNumber)	// Restore old data folder	SetDataFolder savedDFNameEndFunction SyncFitPanelViewToDFState(browserNumber)	// This syncs the indicated FitPanel view to the values of the state variables in the browser's DF,	// which are assumed to be self-consistent.	Variable browserNumber	// Turn off window updates, and output to console	PauseUpdate; Silent 1		// Find name of top browser, switch the DF to its DF, note the former DF name	//Variable browserNumber=GetTopBrowserNumber()	String savedDFName=ChangeToBrowserDF(browserNumber)	// Enable/disable the yOffset hold thing	NVAR holdYOffset=holdYOffset	String fitPanelName=FitPanelNameFromNumber(browserNumber)	if (holdYOffset)		SetVariable yOffsetHoldControl,win=$fitPanelName,disable=0	else		SetVariable yOffsetHoldControl,win=$fitPanelName,disable=2	endif		// Restore old data folder	SetDataFolder savedDFNameEndFunction MarkWaveForAveraging(thisWaveName,filterOnHold,holdCenter,holdTol,filterOnStep,stepCenter)	// Set the DONTAVG wave note on the named wave, based on whether if satisfies the conditions	// as specified by checkHold, holdCenter, etc.	// We assume that thisWaveName is in the current DF, or is an absolute wave name.	String thisWaveName	Variable filterOnHold	// boolean	Variable holdCenter, holdTol	Variable filterOnStep	// boolean	Variable stepCenter	// The default is to include the wave in the average, then we check for a bunch of possible	// reasons to exclude it	WAVE thisWave=$thisWaveName	Variable dontavg=0  // boolean	String waveTypeStr=GetWaveNoteString(thisWave, "WAVETYPE")	if (cmpstr(waveTypeStr,"average")==0)		dontavg = 1	endif	if (!dontavg && GetWaveNoteNumber(thisWave, "REJECT"))		dontavg = 1	endif	if (!dontavg && filterOnHold)		Variable hold=GetWaveNoteNumber(thisWave, "BASELINE")		if ( abs(hold-holdCenter)>holdTol )			dontavg = 1		endif	endif	if (!dontavg && filterOnStep)		Variable step=GetWaveNoteNumber(thisWave, "STEP")		if (abs(step-stepCenter)>0.1)  // tolerance is hard-coded			dontavg = 1		endif	endif	WriteWaveNote(thisWave,"DONTAVG",num2str(dontavg))EndFunction DataProBrowserHook(s)	STRUCT WMWinHookStruct &s		String browserName=s.winName	Variable browserNumber=BrowserNumberFromName(browserName)	String browserDFName=BrowserDFNameFromNumber(browserNumber)		String satelliteWindowName	if (s.eventCode==2)					// window being killed		//Print "Arghhh..."		// Kill Measure panel		satelliteWindowName=MeasurePanelNameFromNumber(browserNumber)		if (PanelExists(satelliteWindowName))			KillWindow $satelliteWindowName		endif		// Kill Fit panel		satelliteWindowName=FitPanelNameFromNumber(browserNumber)		if (PanelExists(satelliteWindowName))			KillWindow $satelliteWindowName		endif		// Kill Average panel		satelliteWindowName=AveragePanelNameFromNumber(browserNumber)		if (PanelExists(satelliteWindowName))			KillWindow $satelliteWindowName		endif		// Kill the data folder		KillDataFolder /Z $browserDFName	elseif (s.eventCode==7)			// cursor moved (or placed)		String cursorName=s.cursorName		NVAR tCursorA		NVAR tCursorB		if ( AreStringsEqual(cursorName,"A") )			tCursorA=xcsr(A,browserName)		elseif ( AreStringsEqual(cursorName,"B") )			tCursorB=xcsr(B,browserName)				endif	elseif (s.eventCode==8)			// graph modified		// We catch this b/c we need to know if the y axis limits change		NVAR yAMin=yAMin		NVAR yAMax=yAMax		NVAR yBMin=yBMin		NVAR yBMax=yBMax		NVAR xMin=xMin		NVAR xMax=xMax		GetAxis /W=$browserName /Q left		if (V_flag==0)  // V_flag will be zero if the axis actually exists			yAMin=V_min			yAMax=V_max		endif		GetAxis /W=$browserName /Q right		if (V_flag==0)  // V_flag will be zero if the axis actually exists			yBMin=V_min			yBMax=V_max		endif		GetAxis /W=$browserName /Q bottom		if (V_flag==0)  // V_flag will be zero if the axis actually exists			xMin=V_min			xMax=V_max		endif	endif	return 0		// If non-zero, we handled event and Igor will ignore it.EndFunction RescaleCheckProc(cbStruct) : CheckBoxControl	STRUCT WMCheckboxAction &cbStruct	Variable browserNumber=BrowserNumberFromName(cbStruct.win)	SyncBrowserViewToDFState(browserNumber)	//SyncDFAxesLimitsWithGraph(browserNumber)	//RescaleAxes(browserNumber)EndFunction RescaleAxes(browserNumber)	// In the indicated DPBrowser, configures the scaling of the graph axes based on 	// the autoscale settings (as reflected in the model), and the axis limits	Variable browserNumber	// Set up access to the DF vars we need	NVAR traceAChecked=traceAChecked	NVAR traceBChecked=traceBChecked		NVAR yAMin=yAMin	NVAR yAMax=yAMax	NVAR yBMin=yBMin	NVAR yBMax=yBMax		NVAR xMin=xMin	NVAR xMax=xMax	NVAR xAutoscaling=xAutoscaling	NVAR yAAutoscaling=yAAutoscaling	NVAR yBAutoscaling=yBAutoscaling		// Change to the DF of the indicated DPBrowser	String savedDF=ChangeToBrowserDF(browserNumber)		// Get the window name of the DPBrowser	String browserName=BrowserNameFromNumber(browserNumber)		// Scale the y axis for trace A	if (traceAChecked)		if (yAAutoscaling)			Setaxis /W=$browserName /Z /A left  // autoscale the left y axis		else			Setaxis /W=$browserName /Z left yAMin, yAMax  // set the y axis to have the limits it currently has		endif	endif		// Scale the y axis for trace B	if (traceBChecked)		if (yBAutoscaling)			Setaxis /W=$browserName /Z /A right  // autoscale the right y axis		else			Setaxis /W=$browserName /Z right yBMin, yBMax  // set the y axis to have the limits it currently has		endif	endif		// Scale the x axis	if ( traceAChecked || traceBChecked )		if (xAutoscaling)			Setaxis /W=$browserName /Z /A bottom    // autoscale the bottom (x) axis		else			Setaxis /W=$browserName /Z bottom xMin, xMax  // set the x axis to have the limits it currently has		endif	endif		// Restore the original DF	SetDataFolder savedDFEndFunction ToolsPanelHook(s)	STRUCT WMWinHookStruct &s		String panelName=s.winName	String browserName=RootWindowName(panelName)	Variable browserNumber=BrowserNumberFromName(browserName)	if (s.eventCode==2)					// window being killed		//Print "The Tools Panel says: Arghhh..."		// Need to uncheck the "Show Tools" checkbox		CheckBox showToolsCheckbox, win=$browserName, value=0	endif			return 0		// If non-zero, we handled event and Igor will ignore it.End