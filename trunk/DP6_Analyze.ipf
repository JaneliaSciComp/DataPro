//	DataPro Analysis//	Adapted from BAD_ASS//	(Browse, Analyze Data, and Average Selected Sweeps, Nelson Spruston, 8/95)//	DataPro Analyze began 8/24/99//	last updated 7/23/02#pragma rtGlobals=1		// Use modern global access method.//________________________DataPro Analyze ______________________//Function AnalyzeButtonProc(ctrlName) : ButtonControl	String ctrlName	Execute "Analysis()"EndFunction GoToSweep(svStruct) : SetVariableControl	// Called when the user changes the sweep number in the DPBrowser, 	// which first changes iCurrentSweep.	STRUCT WMSetVariableAction &svStruct		String browserName=svStruct.win	ControlInfo /W=$browserName setsweep	Variable iSweepInView=V_Value	Variable browserNumber=BrowserNumberFromName(browserName)	SweepIndexChangedInView(browserNumber,iSweepInView)EndFunction HandleBaseNameControl(svStruct) : SetVariableControl	// Called when the user changes the trace name in the control.	STRUCT WMSetVariableAction &svStruct		String browserName=svStruct.win	Variable browserNumber=BrowserNumberFromName(browserName)	SyncBrowserViewToDFState(browserNumber)EndFunction SweepIndexChangedInView(browserNumber,sweepIndexInView)	// Tell the controller that the sweep index has been changed in the view.	Variable browserNumber, sweepIndexInView	// Change to the right DF	String savedDFName=ChangeToBrowserDF(browserNumber)		// Synthesize and store the names of the new waves	SVAR baseName1=baseName1	String newWave1NameMaybe	sprintf newWave1NameMaybe "root:%s%d", baseName1, sweepIndexInView	SVAR baseName2=baseName2	String newWave2NameMaybe		sprintf newWave2NameMaybe "root:%s%d", baseName2, sweepIndexInView		// Check that one of the sweeps exists.  If not, roll back the value	// I think this code is no longer necessary, since the sweep index control now has	// proper limits.	if ( !WaveExists($newWave1NameMaybe) && !WaveExists($newWave2NameMaybe) )		NVAR iCurrentSweep=iCurrentSweep		String browserName=BrowserNameFromNumber(browserNumber)		SetVariable setsweep, win=$browserName, value=_NUM:iCurrentSweep		return 0	endif	// Set the sweep in the "controller"	SetICurrentSweep(browserNumber,sweepIndexInView)		// Restore the original DF	SetDataFolder savedDFName	EndFunction SetICurrentSweep(browserNumber,sweepIndexNew)	// Set the current sweep index to something, which is assumed to be valid.	Variable browserNumber, sweepIndexNew	// Change to the right DF	String savedDFName=ChangeToBrowserDF(browserNumber)		// Set iCurrentSweep, then sync the view with the "controller" state	NVAR iCurrentSweep=iCurrentSweep	iCurrentSweep=sweepIndexNew	SyncBrowserViewToDFState(browserNumber)		// Restore the original DF	SetDataFolder savedDFName	EndFunction SyncBrowserViewToDFState(browserNumber)	// This syncs the indicated DPBrowser view to the values of the state variables in the browser's DF,	// which are assumed to be self-consistent.	Variable browserNumber		// Find name of top browser, switch the DF to its DF, note the former DF name	//Variable browserNumber=GetTopBrowserNumber()	String savedDFName=ChangeToBrowserDF(browserNumber)	// Get references to the DF vars we need	NVAR iCurrentSweep=iCurrentSweep	NVAR clamp_mode=root:DP_ADCDACcontrol:clamp_mode	//NVAR red=red, green=green, blue=blue	Variable red, green, blue	SVAR baseName1=baseName1, baseName2=baseName2, topWaveName=topWaveName	SVAR currentWave1Name=currentWave1Name, currentWave2Name=currentWave2Name	//SVAR oldbname1=oldbname1, oldbname2=oldbname2	WAVE Colors=Colors		// Turn off window updates, and output to console	PauseUpdate; Silent 1		// Remove the old waves from the graph	RemoveBaseNamedWaves(baseName1)	//RemoveBaseNamedWaves(oldbname1)	RemoveBaseNamedWaves(baseName2)	//RemoveBaseNamedWaves(oldbname2)	RemoveBaseNamedWaves("showfit")		// Update the viable range for the current sweep control, and the current sweep	String query1=baseName1+"*"	String query2=baseName2+"*"	SetDataFolder root:	String waveList1=WaveList(query1, ";", "")	String waveList2=WaveList(query2, ";", "")	ChangeToBrowserDF(browserNumber)	Variable nTraces1=ItemsInList(waveList1)	Variable nTraces2=ItemsInList(waveList2)	Variable nTraces=max(nTraces1,nTraces2)	String browserName=BrowserNameFromNumber(browserNumber)	if (nTraces>0)		SetVariable setsweep, win=$browserName, limits={1,nTraces,1}		SetVariable setsweep, win=$browserName, value=_NUM:iCurrentSweep	else		SetVariable setsweep, win=$browserName, limits={1,nTraces,0}		SetVariable setsweep, win=$browserName, value=_STR:"(none)"			endif		// If either wave exists, do baseline subtraction	sprintf currentWave1Name "root:%s%d", baseName1, iCurrentSweep	Variable wave1Exists=WaveExists($currentWave1Name)	sprintf currentWave2Name "root:%s%d", baseName2, iCurrentSweep	Variable wave2Exists=WaveExists($currentWave2Name)	if (wave1Exists || wave2Exists)		DoBaseSub()	endif	// If it exists, add $currentWave2Name to the graph		String browserWindowName=BrowserNameFromNumber(browserNumber)	ControlInfo /W=$browserWindowName show2	if (V_value && wave2Exists)		AppendToGraph $currentWave2Name		red=Colors[1][0]		green=Colors[1][1]		blue=Colors[1][2]		GraphColors(baseName2,iCurrentSweep,red,green,blue)		topWaveName=currentWave2Name	endif		// If it exists, add $currentWave1Name to the graph		ControlInfo /W=$browserWindowName show1	if (V_value && wave1Exists)		AppendToGraph $currentWave1Name		red=Colors[0][0]		green=Colors[0][1]		blue=Colors[0][2]		GraphColors(baseName1,iCurrentSweep,red,green,blue)		topWaveName=currentWave1Name	endif		// Place the cursors	// PlaceCursors(topWaveName)		// Update the rejection box to reflect the reject-status of each wave 	UpdateRejectBox()		// Get the metadata associated with each wave, put relevant values in DF variables	NVAR hold1=hold1, step1=step1	if (wave1Exists)		ControlInfo /W=$browserName show1  // show1 is the checkbox in the DP Browser that says whether to show chan 1		if (V_value)  // V_value is 1 iff show1 is checked			hold1=GetWaveNoteNumber($currentWave1Name,"BASELINE")			step1=GetWaveNoteNumber($currentWave1Name,"STEP")		else			hold1=NaN;			step1=NaN;		endif	else		hold1=NaN;		step1=NaN;	endif	NVAR hold2=hold2, step2=step2	if (wave2Exists)		ControlInfo /W=$browserName show2  // show2 is the checkbox in the DP Browser that says whether to show chan 2		if (V_value)			hold2=GetWaveNoteNumber($currentWave2Name,"BASELINE")			step2=GetWaveNoteNumber($currentWave2Name,"STEP")		else			hold2=NaN;			step2=NaN;		endif	else		hold2=NaN;		step2=NaN;	endif		// Show Comments in the view	GetComments()		// If there is one or more trace in the graph, make sure the axes of the graph are	// consistent with the autoscaling checkboxes, and turn on horizontal grid lines.	if (strlen(TraceNameList(browserWindowName,";",1))>1)		RescaleAxes(browserNumber)		ModifyGraph /W=$browserWindowName grid(left)=1	endif		// Set axis labels on the graph	String theAxisList=AxisList(browserWindowName)	if (GrepString(theAxisList,"bottom"))		Label /W=$browserWindowName bottom "\\F'Helvetica'\\Z12\\f01Time (ms)"	endif	if (GrepString(theAxisList,"left"))			if (clamp_mode<1)			Label /W=$browserWindowName left "\\F'Helvetica'\\Z12\\f01Current (pA)"		else			Label /W=$browserWindowName left "\\F'Helvetica'\\Z12\\f01Voltage (mV)"		endif	endif		// Restore old data folder	SetDataFolder savedDFNameEndFunction AppRemSweep(cbStruct) : CheckBoxControl	// This is called when the user checks/unchecks the "ch.1" or "ch.2" checkboxes in a	// DPBrowser window.  Currently, this automatically changes the DF state variables.	STRUCT WMCheckboxAction &cbStruct		Variable browserNumber=BrowserNumberFromName(cbStruct.win)		SyncBrowserViewToDFState(browserNumber)EndFunction RemoveBaseNamedWaves(base)	String base	String savDF, targetWindow, allwaves, thiswave	Variable i	savDF=GetDataFolder(1)	SetDataFolder root:	base+="*"	sprintf targetWindow, "WIN:"	allwaves=WaveList(base,";", targetWindow)	if (strlen(allwaves)>0)		i=0		do			thiswave=GetStrFromList(allwaves,i,";")			if (strlen(thiswave)==0)				break			else				RemoveFromGraph $thiswave			endif			i+=1		while(1)	endif	SetDataFolder savDFEndFunction UpdateRejectBox()	// Look at the wave notes for $currentWave1Name and $currentWave2Name, and update the	// Reject checkboxes to reflect their rejection-status 	// Find name of top browser, switch the DF to its DF, note the former DF name	Variable browserNumber=GetTopBrowserNumber()	String savDF=ChangeToBrowserDF(browserNumber)		// Update the currentWave1Name reject checkbox	SVAR currentWave1Name=currentWave1Name	ControlInfo show1	if ((V_value>0) && (exists(currentWave1Name)==1))		WAVE Wave1=$currentWave1Name		CheckBox reject1, value=GetWaveNoteNumber(Wave1,"REJECT")	endif		// Update the currentWave2Name reject checkbox	SVAR currentWave2Name=currentWave2Name	ControlInfo show2	if ((V_value>0) && (exists(currentWave2Name)==1))		WAVE Wave2=$currentWave2Name		CheckBox reject2, value=GetWaveNoteNumber(Wave2,"REJECT")	endif		// Restore the original DF	SetDataFolder savDFEndFunction GetComments()	// Read the comments out of the currently-showing waves, and update the comments variable	// to update the comments text box.	// Find name of top browser, switch the DF to its DF, note the former DF name	Variable browserNumber=GetTopBrowserNumber()	String savDF=ChangeToBrowserDF(browserNumber)	SVAR comments=comments	SVAR currentWave1Name=currentWave1Name	SVAR currentWave2Name=currentWave2Name	WAVE Wave1=$currentWave1Name	WAVE Wave2=$currentWave2Name	ControlInfo show1	if ((V_value>0) && (exists(currentWave1Name)==1))		comments=GetWaveNoteString(Wave1,"COMMENTS")	else		ControlInfo show2		if ((V_value>0) && (exists(currentWave2Name)==1))			comments=GetWaveNoteString(Wave2,"COMMENTS")		endif	endif		// Restore the original DF	SetDataFolder savDFEndFunction RejectAccept(ctrlName,rejcheck) : CheckBoxControl	String ctrlName	Variable rejcheck	// Find name of top browser, switch the DF to its DF, note the former DF name	Variable browserNumber=GetTopBrowserNumber()	String savDF=ChangeToBrowserDF(browserNumber)	if (cmpstr(ctrlName,"reject1")==0)		SVAR wavename=currentWave1Name	else		SVAR wavename=currentWave2Name	endif	SetDataFolder root:	WriteWaveNote($wavename,"REJECT",num2str(rejcheck)+"\r")	SetDataFolder savDFEndFunction BaseSub(ctrlName,bsubcheck) : CheckBoxControl	String ctrlName	Variable bsubcheck	DoBaseSub()	RescaleTopAxes()//	UpdateValues()EndFunction DoBaseSub()	// Perform baseline subtraction on $currentWave1Name and $currentWave2Name.	// Each wave's note says whether it has had the baseline subtracted, and also	// contains the baseline value for that wave.		// Find name of top browser, switch the DF to its DF, note the former DF name	Variable browserNumber=GetTopBrowserNumber()	String savedDFName=ChangeToBrowserDF(browserNumber)		NVAR iCurrentSweep=iCurrentSweep	SVAR currentWave1Name=currentWave1Name, currentWave2Name=currentWave2Name	SVAR baseName1=baseName1, baseName2=baseName2	sprintf currentWave1Name "root:%s%d", baseName1, iCurrentSweep	sprintf currentWave2Name "root:%s%d", baseName2, iCurrentSweep	WAVE theWave=$currentWave1Name	Variable basesubtracted, baseline	ControlInfo show1	if ((V_value>0) && (exists(currentWave1Name)==1))		baseline=GetWaveNoteNumber(theWave,"BASELINE")		basesubtracted=GetWaveNoteNumber(theWave,"BASESUBTRACTED")//		print baseline, basesubtracted	endif	ControlInfo basesub1	if ((V_value>0) && (exists(currentWave2Name)==1))			// if baseline subtract is checked		 if (basesubtracted<1)							// but the baseline isn't subtracted			theWave -=  baseline							// subtract baseline			WriteWaveNote($currentWave1Name,"BASESUBTRACTED","1")	// and note baseline subtracted		endif	else												// if baseline subtract is not checked		 if (basesubtracted>0)							// but the baseline is subtracted			theWave +=  baseline							// add back the baseline			WriteWaveNote($currentWave1Name,"BASESUBTRACTED","0")	// and note baseline not subtracted		endif	endif	ControlInfo show2	if ((V_value>0) && (exists(currentWave2Name)==1))		WAVE theWave=$currentWave2Name		baseline=GetWaveNoteNumber(theWave,"BASELINE")		basesubtracted=GetWaveNoteNumber(theWave,"BASESUBTRACTED")	endif	ControlInfo basesub2	if ((V_value>0) && (exists(currentWave2Name)==1))				// if baseline subtract is checked		 if (basesubtracted<1)							// but the baseline isn't subtracted			theWave -=  baseline							// subtract baseline			WriteWaveNote(theWave,"BASESUBTRACTED","1")	// and note baseline subtracted		endif	else												// if baseline subtract is not checked		 if (basesubtracted>0)							// but the baseline is subtracted			theWave +=  baseline							// add back the baseline			WriteWaveNote(theWave,"BASESUBTRACTED","0")	// and note baseline not subtracted		endif	endif		// Restore the original DF.	SetDataFolder savedDFNameEndFunction GraphColors(thename, sweep, rval, gval, bval)	String thename	Variable sweep, rval, gval, bval	String thewave=thename+num2istr(sweep)	ModifyGraph rgb($thewave)=(rval,gval,bval)	ModifyGraph grid(left)=1	ModifyGraph tickUnit(bottom)=1	ModifyGraph tickUnit(left)=1EndFunction Measure(bStruct) : ButtonControl	STRUCT WMButtonAction &bStruct		if (bStruct.eventCode!=2)		return 0							// we only handle mouse up in control	endif	String browserName=bStruct.win;	Variable browserNumber=BrowserNumberFromName(browserName);	PauseUpdate; Silent 1		// building window...	String measurePanelName=sprintf1d("MeasurePanel%d",browserNumber)	if (PanelExists(measurePanelName))		DoWindow /F $measurePanelName	else		String createPanel		sprintf createPanel "MeasurePanel(%d)" browserNumber		Execute createPanel	endif	UpdateValues(browserNumber)EndFunction AverageSweeps(ctrlName) : ButtonControl	String ctrlName	PauseUpdate; Silent 1		// building window...	String createpanel	createpanel="AveragePanel()"	if (wintype("AveragePanel")!=7)		Execute createpanel	else		DoWindow /F AveragePanel	endif	DoWindow /F DataBrowserEndFunction Fit(bStruct) : ButtonControl	STRUCT WMButtonAction &bStruct		if (bStruct.eventCode!=2)		return 0							// we only handle mouse up in control	endif	String browserName=bStruct.win;	Variable browserNumber=BrowserNumberFromName(browserName);	PauseUpdate; Silent 1		// building window...	String fitPanelName=sprintf1d("FitPanel%d",browserNumber)	if (PanelExists(fitPanelName))		DoWindow /F $fitPanelName	else		String commandString=sprintf1d("FitPanel(%d)",browserNumber)		Execute commandString	endif	UpdateValues(browserNumber)EndFunction UpdateValues(browserNumber)	// Updates the values displayed in the Measure Panel to reflect the wave currently displayed in	// the DP Browser, given the current measurement parameters in the DF.	Variable browserNumber  // the index of the DP browser instance		// Save the current DF, set the data folder to the appropriate one for this DataProBrowser instance	String savDF=GetDataFolder(1)	String browserDFName=BrowserDFNameFromNumber(browserNumber)	SetDataFolder browserDFName		// Get references to all the variables that we need in this data folder	NVAR hold1=hold1, step1=step1, hold2=hold2, step2=step2	NVAR tBaselineLeft=tBaselineLeft, tBaselineRight=tBaselineRight	NVAR tWindow1Left=tWindow1Left, tWindow1Right=tWindow1Right	NVAR tWindow2Left=tWindow2Left, tWindow2Right=tWindow2Right	SVAR currentWave1Name=currentWave1Name	SVAR currentWave2Name=currentWave2Name	SVAR topWaveName=topWaveName	SVAR comments=comments	NVAR to1, from1	NVAR to2, from2	NVAR base, mean1, peak1, rise1	NVAR mean2, peak2, rise2	NVAR lev1, cross1	//	// Get the metadata associated with each wave, put relevant values in DF variables//	String browserName=BrowserNameFromNumber(browserNumber)//	if (strlen(currentWave1Name)>0)//		ControlInfo /W=$browserName show1  // show1 is the checkbox in the DP Browser that says whether to show chan 1//		if (V_value)  // V_value is 1 iff show1 is checked//			hold1=GetWaveNoteNumber($currentWave1Name,"BASELINE")//			step1=GetWaveNoteNumber($currentWave1Name,"STEP")//			comments=GetWaveNoteString($currentWave1Name,"COMMENTS")//		endif//	endif//	if (strlen(currentWave2Name)>0)	//		ControlInfo /W=$browserName show2  // show2 is the checkbox in the DP Browser that says whether to show chan 2//		if (V_value)//			hold2=GetWaveNoteNumber($currentWave2Name,"BASELINE")//			step2=GetWaveNoteNumber($currentWave2Name,"STEP")//		endif//	endif		// If there's a top wave, calculate features of it	if (strlen(topWaveName)>0)		// Calculate the baseline		//WAVE thisWave=CsrWaveRef(A)		WAVE thisWave=$topWaveName		if (exists("baselineMarkerLeft")==1)			if ((tBaselineLeft<leftx(thisWave)) || (tBaselineRight>rightx(thisWave)))				RemoveBaseNamedWaves("tBaseline")			endif			base=mean($currentWave1Name,tBaselineLeft,tBaselineRight)		else			base=NaN		endif				// Calculate features of window 1		if (exists("window1MarkerLeft")==1)			if ((tWindow1Left<leftx(thisWave)) || (tWindow1Right>rightx(thisWave)))				RemoveBaseNamedWaves("window1Marker")			endif			WaveStats /Q/R=(tWindow1Left,tWindow1Right) thisWave			mean1=V_avg-base			if (abs(V_min-base)>abs(V_max-base))				peak1=V_min-base			else				peak1=V_max-base				endif			rise1=RiseTime(thisWave,tWindow1Left,tWindow1Right,base,peak1,from1/100,to1/100)			cross1=CountThresholdCrossings(thisWave, tWindow1Left, tWindow1Right, lev1)		else			mean1=NaN			peak1=NaN			rise1=NaN		endif				// Calculate features of window 2		if (exists("window2MarkerLeft")==1)			if ((tWindow2Left<leftx($topWaveName)) || (tWindow2Right>rightx($topWaveName)))				RemoveBaseNamedWaves("window2Marker")			endif			WaveStats /Q/R=(tWindow2Left,tWindow2Right) thisWave			mean2=V_avg-base			if (abs(V_min-base)>abs(V_max-base))				peak2=V_min-base			else				peak2=V_max-base					endif			rise2=RiseTime(thisWave,tWindow2Left,tWindow2Right,base,peak2,from2/100,to2/100)			//FindRise(2)		else			mean2=NaN			peak2=NaN			rise2=NaN		endif	endif		// Restore the original data folder	SetDataFolder savDFEndFunction SetBaseline(bStruct) : ButtonControl	STRUCT WMButtonAction &bStruct		// Check that this is really a button-up on the button	if (bStruct.eventCode!=2)		return 0							// we only handle mouse up in control	endif		// Get the browser number from the bStruct	String measurePanelName=bStruct.win;	Variable browserNumber=BrowserNumberFromName(measurePanelName);		// Save the current DF, set the data folder to the appropriate one for this DataProBrowser instance	String savDF=GetDataFolder(1)	String browserDFName=BrowserDFNameFromNumber(browserNumber)	SetDataFolder browserDFName	// Draw vertical lines to indicate the margins of the baseline time range	String browserName=BrowserNameFromNumber(browserNumber)	NVAR tBaselineLeft=tBaselineLeft		tBaselineLeft=xcsr(A,browserName)  //times of left and right cursor that delineate the baseline region	NVAR tBaselineRight=tBaselineRight	tBaselineRight=xcsr(B,browserName)	SVAR currentWave1Name=currentWave1Name  // actually the name of a wave, not the wave itself	AddCursorLineToGraph(browserName,currentWave1Name,"baselineMarkerLeft",tBaselineLeft)	AddCursorLineToGraph(browserName,currentWave1Name,"baselineMarkerRight",tBaselineRight)		// Update all the measured values for this DP browser	UpdateValues(browserNumber)		// Restore the orignal DF	SetDataFolder savDF	EndFunction AddCursorLineToGraph(graphName,sourceWaveName,cursorWaveName,tCursor)	// Adds a wave to the named graph that represents a cursor position.	String graphName  // the name of the graph to add the cursor line to	String sourceWaveName  // the name of the wave for which the cursor is being drawn	String cursorWaveName  // the name of the wave that is the cursor	Variable tCursor // the time at which to place the cursor		WaveStats $sourceWaveName	Variable yMax=V_max  // V_max from WaveStats	Variable yMin=V_min  // V_min from WaveStats	Variable yRange=(yMax-yMin)	if (yRange<=0)		yRange=1;	endif	Variable yMaxCursor=yMax+0.05*yRange	Variable yMinCursor=yMin-0.05*yRange	Make /O/N=2 $cursorWaveName ={yMinCursor,yMaxCursor}	Setscale /I x, tCursor, tCursor+0.1, "ms", $cursorWaveName	String windowSpec=sprintf1s("WIN:%s",graphName)	if (strlen(WaveList(cursorWaveName,";",windowSpec))>0)		RemoveFromGraph $cursorWaveName  // remove if already present	endif	AppendToGraph $cursorWaveNameEndFunction SetWin(bStruct) : ButtonControl	STRUCT WMButtonAction &bStruct		// Check that this is really a button-up on the button	if (bStruct.eventCode!=2)		return 0							// we only handle mouse up in control	endif	// Dispatch on the control name	if (cmpstr(bStruct.ctrlName,"setwin_1")==0)		SetTheWin(1,bStruct)	else		SetTheWin(2,bStruct)	endifEndFunction SetTheWin(n,bStruct)	Variable n  // The index of the data window being set (either 1 or 2)	STRUCT WMButtonAction &bStruct		// Save the current DF, set the data folder to the appropriate one for this DataProBrowser instance	String savDF=GetDataFolder(1)	String measurePanelName=bStruct.win;	Variable browserNumber=BrowserNumberFromName(measurePanelName)	String browserDFName=BrowserDFNameFromNumber(browserNumber)	SetDataFolder browserDFName	// Set up aliases depending on n		if (n==1)		NVAR tWindow1Left=tWindow1Left		NVAR tWindow1Right=tWindow1Right		Make /O/N=2 window1MarkerLeft, window1MarkerRight		NVAR tWindowLeft=tWindow1Left, tWindowRight=tWindow1Right		WAVE windowMarkerLeft=window1MarkerLeft, windowMarkerRight=window1MarkerRight	else		NVAR tWindow2Left=tWindow2Left		NVAR tWindow2Right=tWindow2Right		Make /O/N=2 window2MarkerLeft, window2MarkerRight		NVAR tWindowLeft=tWindow2Left, tWindowRight=tWindow2Right		WAVE windowMarkerLeft=window2MarkerLeft, windowMarkerRight=window2MarkerRight	endif		// Draw vertical lines to indicate the margins of the window time range	tWindowLeft=xcsr(A)  // times of left and right cursor that delineate the window region	tWindowRight=xcsr(B)	SVAR currentWave1Name=currentWave1Name 	WaveStats $currentWave1Name	Variable yMax=V_max  // V_max from WaveStats	Variable yMin=V_min  // V_min from WaveStats	Variable yRange=(yMax-yMin)	Variable yMaxCursor=yMax+0.05*yRange	Variable yMinCursor=yMin-0.05*yRange	//Make /O/N=2 windowMarkerLeft, windowMarkerRight	windowMarkerLeft[0]=yMinCursor	windowMarkerLeft[1]=yMaxCursor	Setscale /I x, tWindowLeft, tWindowLeft+0.1, "ms", windowMarkerLeft	windowMarkerRight[0]=yMinCursor	windowMarkerRight[1]=yMaxCursor	Setscale /I x, tWindowRight, tWindowRight+0.1, "ms", windowMarkerRight	String browserName=BrowserNameFromNumber(browserNumber)	String windowSpec	sprintf windowSpec "WIN:%s" browserName	String alreadythere	if (n==1)		alreadythere=WaveList("window1MarkerLeft",";",windowSpec)		if (CmpStr(alreadythere,"")!=0)			RemoveFromGraph window1MarkerLeft, window1MarkerRight		endif		AppendtoGraph windowMarkerLeft, windowMarkerRight		ModifyGraph rgb(window1MarkerLeft)=(3,52428,1)		ModifyGraph rgb(window1MarkerRight)=(3,52428,1)	else		alreadythere=WaveList("window2MarkerLeft",";",windowSpec)		if (CmpStr(alreadythere,"")!=0)			RemoveFromGraph window2MarkerLeft, window2MarkerRight		endif		AppendtoGraph windowMarkerLeft, windowMarkerRight		ModifyGraph rgb(window2MarkerLeft)=(0,0,65535)		ModifyGraph rgb(window2MarkerRight)=(0,0,65535)	endif	// Update the values for this browser	UpdateValues(browserNumber)		// Restore the orignal DF	SetDataFolder savDF	EndFunction UpdateRise(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	if ( (cmpstr(varName,"from1")==0) || (cmpstr(varName,"to1")==0))		// Update rise time for window 1		NVAR tWindow1Left=tWindow1Left, tWindow1Right=tWindow1Right		NVAR to1, from1, peak1, base		SVAR topWaveName=topWaveName		WAVE topWave=$topWaveName			NVAR rise1		rise1=RiseTime(topWave,tWindow1Left,tWindow1Right,base,peak1,from1/100,to1/100)		//FindRise(1)	else		// Update rise time for window 2		NVAR tWindow2Left=tWindow2Left, tWindow2Right=tWindow2Right		NVAR to2, from2, peak2, base		SVAR topWaveName=topWaveName		WAVE topWave=$topWaveName			NVAR rise2		rise2=RiseTime(topWave,tWindow2Left,tWindow2Right,base,peak2,from2/100,to2/100)		//FindRise(2)	endifEnd//Function FindRise(n)//	Variable n  // The index of the data window being set (either 1 or 2)//	//	// Set references as appropriate for this data window//	if (n==1)//		NVAR left=tWindow1Left, right=tWindow1Right, base=base//		NVAR peak=peak1, from=from1, to=to1, rise=rise1//	endif//	if (n==2)//		NVAR left=tWindow2Left, right=tWindow2Right, base=base//		NVAR peak=peak2, from=from2, to=to2, rise=rise2//	endif//	//	SVAR topWaveName=topWaveName//	WAVE topWave=$topWaveName//	Variable first//	FindLevel /Q/R=(left,right) topWave, base+from*peak/100  // find level crossings//	if (V_flag<1)  // true means level was found//		first=V_LevelX//	else//		first=NaN//	endif//	Variable second//	FindLevel /Q/R=(first,right) topWave, base+to*peak/100//	if (V_flag<1)//		second=V_LevelX//	else//		second=NaN//	endif//	rise=round((second-first)*100)/100//EndFunction RiseTime(thisWave,tLeft,tRight,yBase,dyPeak,fracFrom,fracTo)	Wave thisWave	Variable tLeft,tRight, yBase, dyPeak, fracFrom, fracTo	Variable yFrom=yBase+fracFrom*dyPeak	FindLevel /Q/R=(tLeft,tRight) thisWave, yFrom  // find level crossing	Variable tFrom= (V_flag==0) ? V_LevelX : NaN	Variable yTo=yBase+fracTo*dyPeak	FindLevel /Q/R=(tLeft,tRight) thisWave, yTo  // find level crossing	Variable tTo= (V_flag==0) ? V_LevelX : NaN	Variable tRise=tTo-tFrom	return tRiseEndFunction UpdateLevels(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName		//FindTheLevels(1)	NVAR cross1	SVAR topWaveName=topWaveName	WAVE theWave=$topWaveName	NVAR tWindow1Left=tWindow1Left, tWindow1Right=tWindow1Right, lev1=lev1	NVAR cross1=cross1	cross1=CountThresholdCrossings(theWave, tWindow1Left, tWindow1Right, lev1)End//Function FindTheLevels(n)//	Variable n//	if (n==1)//		NVAR left=tWindow1Left, right=tWindow1Right, lev=lev1, cross=cross1//	else//		NVAR left=tWindow2Left, right=tWindow2Right, lev=lev2, cross=cross2//	endif//	SVAR topWaveName=topWaveName//	WAVE theWave=$topWaveName//	FindLevels /Q/R=(left,right) theWave, lev//	cross=V_LevelsFound//EndFunction CountThresholdCrossings(theWave, tWindowLeft, tWindowRight, threshold)	Wave theWave	Variable tWindowLeft, tWindowRight, threshold	if (threshold!=threshold)  // true iff threshold is nan		return nan	endif	FindLevels /Q/R=(tWindowLeft,tWindowRight) theWave, threshold	return V_LevelsFoundEndFunction AverageSelectedSweeps(ctrlName) : ButtonControl	String ctrlName	DoAverage()EndFunction DoAverage()	PauseUpdate; Silent 1	String savDF=GetDataFolder(1)	SetDataFolder root:DP_Analysis	Variable from, to, i, avgflag1, avgflag2, dontavg1, dontavg2, reject1, reject2	String wave1, wave2, wt1, wt2	Variable ch1, ch2	NVAR firstwave=firstwave, lastwave=lastwave, avgto=avgto, avgfrom=avgfrom	NVAR hold1=hold1, hold2=hold2, step1=step1, step2=step2, avghold=avghold	NVAR holdtolerance=holdtolerance, avgstep=avgstep	SVAR baseName1=root:DP_Browser:baseName1, baseName2=root:DP_Browser:baseName2	ControlInfo /W=AveragePanel range_all	if (V_value>0)		from=firstwave		to=lastwave	else		from=avgfrom		to=avgto	endif	i=from	Controlinfo /W=DataProBrowser show1	if (V_value>0)		ch1=1	endif	Controlinfo /W=DataProBrowser show2	if (V_value>0)		ch2=1	endif	DoWindow /F AveragePanel	SetDataFolder root:	i=from	do		dontavg1=0; dontavg2=0		sprintf wave1, "%s%d", baseName1, i		sprintf wave2, "%s%d", baseName2, i		if (ch1>0)			wt1=GetWaveNoteString($wave1, "WAVETYPE")			if (cmpstr(wt1,"average")==0)				avgflag1=1				dontavg1 += 1			endif			reject1=GetWaveNoteNumber($wave1, "REJECT")			if (reject1>0)				dontavg1 += 10			endif		endif		if (ch2>0)			wt2=GetWaveNoteString($wave2, "WAVETYPE")			if (cmpstr(wt2,"average")==0)				avgflag2=1				dontavg2 += 1			endif			reject2=GetWaveNoteNumber($wave2, "REJECT")			if (reject2>0)				dontavg2 += 10			endif		endif		ControlInfo /W=AveragePanel hold_all		if (V_value<1)			if (ch1>0)				hold1=GetWaveNoteNumber($wave1, "BASELINE")				if ( (hold1<avghold-holdtolerance) %| (hold1>avghold+holdtolerance) )					dontavg1 += 100				endif			endif			if (ch2>0)				hold2=GetWaveNoteNumber($wave2, "BASELINE")				if ( (hold2<avghold-holdtolerance) %| (hold2>avghold+holdtolerance) )					dontavg2 += 100				endif			endif		endif		ControlInfo /W=AveragePanel step_all		if (V_value<1)			if (ch1>0)				step1=GetWaveNoteNumber($wave1, "STEP")				if (abs(step1-avgstep)>0.1)					dontavg1 += 1000				endif			endif			if (ch2>0)				step2=GetWaveNoteNumber($wave2, "STEP")				if (abs(step2-avgstep)>0.001)					dontavg2 += 1000				endif			endif		endif		if (ch1>0)			WriteWaveNote($wave1,"DONTAVG",num2str(dontavg1))		endif		if (ch2>0)			WriteWaveNote($wave2,"DONTAVG",num2str(dontavg2))		endif		i+=1	while(i<to+1)	if (ch1>0)		AvgLoop(1,baseName1)	endif	if (ch2>0)		AvgLoop(2,baseName2)	endif	SetDataFolder savDFEndFunction AvgLoop(channel, wavebase)	Variable channel	String wavebase	String savDF=GetDataFolder(1)	SetDataFolder root:DP_Analysis	String nextwavestr, savedest, avgmessage	Variable dontavg, index, i, to, from	NVAR avgto=avgto, avgfrom=avgfrom, avgstep=avgstep//	SVAR destwave=root:destwave	String destwave	SVAR base1=root:DP_Browser:baseName1, base2=root:DP_Browser:baseName2	NVAR wavenumber=root:DP_ADCDACcontrol:wavenumber	SetDataFolder root:DP_ADCDACcontrol	if (channel<2)		sprintf destwave "%s%d", base1, wavenumber	else		sprintf destwave "%s%d", base2, wavenumber	endif	wavenumber+=1	SetDataFolder root:	to=avgto	from=avgfrom	index=0	i=from	do		sprintf nextwavestr "%s%d", wavebase, i		WAVE nextwave=$nextwavestr		dontavg=GetWaveNoteNumber(nextwave,"DONTAVG")		if (dontavg<1)			if (index<1)				Duplicate /O nextwave root:$destwave				WAVE outwave=root:$destwave				Note /K outwave				WriteWaveNote(outwave,"WAVETYPE","average")				WriteWaveNote(outwave,"TIME",time())				WriteWaveNote(outwave,"DONTAVG","1")				WriteWaveNote(outwave,"STEP",num2str(avgstep)+"\r")				outwave = 0			endif			outwave += nextwave			index += 1		endif		i+=1	while(i<to+1)	if (index>0)		outwave /= index	else		sprintf avgmessage, "Ch.%d: No waves met your criteria to be averaged.", channel		SetDataFolder savDF		Abort avgmessage	endif	sprintf avgmessage "Ch.%d: %d waves were averaged and stored in %s", channel, index, destwave	print avgmessage	ControlInfo saveavg		if (V_value>0)		sprintf savedest "%s.avg", destwave		Save/C/I outwave as savedest		sprintf avgmessage "Ch.%d: Average saved to disk as %s", channel, savedest	else		sprintf avgmessage "Ch.%d: Average not saved to disk", channel	endif	print avgmessage	SetDataFolder savDFEnd//Proc AvgOutName(outwave, avgprompt)//	String outwave, avgprompt//	Prompt outwave, avgprompt//	destwave=outwave//EndFunction SetFitZero(bStruct) : ButtonControl	STRUCT WMButtonAction &bStruct		// Check that this is really a button-up on the button	if (bStruct.eventCode!=2)		return 0							// we only handle mouse up in control	endif		// Get the browser number from the bStruct	Variable browserNumber=BrowserNumberFromName(bStruct.win);		// Save the current DF, set the data folder to the appropriate one for this DataProBrowser instance	String savedDFName=ChangeToBrowserDF(browserNumber)	// Draw vertical line to indicate the cursor	String browserName=BrowserNameFromNumber(browserNumber)	NVAR tFitZero=tFitZero	tFitZero=xcsr(A,browserName)	SVAR currentWave1Name=currentWave1Name  // actually the name of a wave, not the wave itself	AddCursorLineToGraph(browserName,currentWave1Name,"fitLineZero",tFitZero)	ModifyGraph rgb(fitLineZero)=(26411,1,52428)		// Restore original DF	SetDataFolder savedDFNameEndFunction SetFitRange(bStruct) : ButtonControl	STRUCT WMButtonAction &bStruct		// Check that this is really a button-up on the button	if (bStruct.eventCode!=2)		return 0							// we only handle mouse up in control	endif		// Get the browser number from the bStruct	Variable browserNumber=BrowserNumberFromName(bStruct.win);		// Save the current DF, set the data folder to the appropriate one for this DataProBrowser instance	String savedDFName=ChangeToBrowserDF(browserNumber)	// Draw vertical line to indicate the cursor	String browserName=BrowserNameFromNumber(browserNumber)	NVAR tFitLeft=tFitLeft	tFitLeft=xcsr(A,browserName)	NVAR tFitRight=tFitRight	tFitRight=xcsr(B,browserName)	SVAR currentWave1Name=currentWave1Name  // actually the name of a wave, not the wave itself	AddCursorLineToGraph(browserName,currentWave1Name,"fitLineLeft",tFitLeft)	AddCursorLineToGraph(browserName,currentWave1Name,"fitLineRight",tFitRight)	ModifyGraph rgb(fitLineLeft)=(0,65535,65535)	ModifyGraph rgb(fitLineRight)=(0,65535,65535)		// Restore original DF	SetDataFolder savedDFNameEndFunction ExponentialFit(ctrlName) : ButtonControl	String ctrlName	Execute "DoFit()"EndFunction DoFit()	SVAR currentWave1Name=currentWave1Name	NVAR tFitZero=tFitZero	NVAR yOffset=yOffset	NVAR amp1=amp1, tau1=tau1, amp2=amp2, tau2=tau2	NVAR tFitRight=tFitRight	NVAR fitextend=fitextend	WAVE W_coef=W_coef	PauseUpdate; Silent 1		// building window...	Variable left, right, hold	String S_value, FitCommand, fitthere	Duplicate /O $currentWave1Name fitwave	left=leftx($currentWave1Name)-tFitZero	right=pnt2x($currentWave1Name,numpnts($currentWave1Name)-1)-tFitZero	Setscale /I x, left,right, "ms", fitwave	FitCommand="CurveFit "	ControlInfo yOffset_check	if (V_value<1)		hold=0	else			hold=1	endif	ControlInfo fit_function	if (cmpstr(S_value,"single exp")==0)		if (hold>0)			FitCommand+="/H=\"100\" "		endif		FitCommand+="exp, "	else		if (hold>0)			FitCommand+="/H=\"10000\" "		endif		FitCommand+="dblexp, "	endif	FitCommand+="fitwave(tFitLeft-tFitZero,tFitRight-tFitZero)"	Execute FitCommand	yOffset=W_coef[0]	amp1=W_coef[1]	tau1=1/W_coef[2]	amp2=W_coef[3]	tau2=1/W_coef[4]	if (cmpstr(S_value,"single exp")==0)		amp2=0		tau2=0	endif	Make /O/N=500 showfit	Setscale /I x, 0, tFitRight+fitextend-tFitZero, "ms", showfit	showfit= yOffset+amp1*exp(-x/tau1)+amp2*exp(-x/tau2)	Setscale /I x, tFitZero, tFitRight+fitextend, "ms", showfit	DoWindow /F DataBrowser	fitthere=WaveList("showfit",";","WIN:DataBrowser")	if (CmpStr(fitthere,"")==0)		AppendtoGraph showfit	endifEndProc DataBrowser_Help()	String AbortMessage	AbortMessage="To get help, open the 'DataBrowser_Help' file (as a help file) or "	AbortMessage+= "double click on the icon in the finder.  After doing so, 'DataBrowser_Help' "	AbortMessage+= "will appear under 'Help Windows' in the Igor 'Windows' pulldown"	Abort AbortMessageEnd//-------------------------USEFUL ANALYSIS UTILITIES-------------------------//Proc SetDataUnits(match,units)	String match, units	String list, command	list=Wavelist(match,",","")	sprintf command "SetScale d 0,0,\"%s\" %s", units, list	print command	Execute commandEndProc GetRidofGraphAxes()	ModifyGraph noLabel=2,axThick=0EndProc DisplaySeries(name,first,n,left,top,right,bottom)	String name, wave	Variable first=0, n=1, left=0, top=0, right=700, bottom=500	iterate(n)		sprintf wave "%s%d", name, first+i		if (i==0)			Display /W=(left,top,right,bottom) $wave			PauseUpdate		else			Append $wave		endif	loop	Modify rgb=(0,0,0)	Modify axThick=0	Modify noLabel=2	Modify lsize=0.7EndProc KillWindows()	Silent 1	String name, list	String win	Variable index=0	list = Winlist("*",";","WIN:7")	do		| get the next window		win = GetStrFromList(list, index, ";")		if (strlen(win) == 0)			break		else			DoWindow /K $win		endif		index += 1	while (1) | loop until break aboveEndProc KillWavesWithName(name)	String name, list, match	Silent 1	String wave	Variable index=0	sprintf match "%s*", name	list = Wavelist(match,";","")	do		| get the next wave		wave = GetStrFromList(list, index, ";")		if (strlen(wave) == 0)			break		else			KillWaves $wave		endif		index += 1	while (1) | loop until break aboveEndFunction Inflection(wave,level,left,right)//	Finds inflection point of a wave	String wave	Variable level, left, right	String diff	sprintf diff, "diff_%s", wave[0]	Duplicate /O $wave $diff	Smooth/S=4/E=3 7, $diff	Differentiate $diff	FindLevel /Q/R=(left,right) $diff, level	return V_LevelXEndFunction niceround(x)	Variable x	do		if (x<5)			x=round(x)			break		endif		if (x<10)			x=round(x/5)*5			break		endif		if (x<50)			x=round(x/10)*10			break		endif		if (x<100)			x=round(x/25)*25			break		endif		if (x<250)			x=round(x/50)*50			break		else			x=round(x/100)*100		endif	while(0)	return xEnd//-----------------------Calibrator from Wavemetrics------------------------//Function InitCalibratorGlobals()	String/G u_xaxis="bottom",u_yaxis="left"	Variable/G/D u_dx=1,u_dy=1	Variable/G u_orient=3,u_label=3	// lower-left, print with unitsEndProc Calibrator()	if (exists("u_xaxis")<2)		InitCalibratorGlobals()	endif	WMCalibrator()EndProc WMCalibrator(xaxis,yaxis,dx,dy,orient,label)	String xaxis=u_xaxis, yaxis=u_yaxis	Variable/D dx=u_dx,dy=u_dy	Variable orient=u_orient,label=u_label	Prompt xaxis,"X axis (horizontal axis)",popup,HVAxisList("",1)	//  only horizontal axes	Prompt yaxis,"Y axis (vertical axis)",popup,HVAxisList("",0)	//  only vertical axes	Prompt dx,"calibrator X length, or 0 for none"	Prompt dy,"calibrator Y length, or 0 for none"	Prompt orient,"Orientation",popup,"upper-left;upper-right;lower-right;lower left;"	Prompt label,"print values",popup,"donÕt print;print;print with units;print with units and ,K,m,µ etc"		PauseUpdate;Silent 1	u_xaxis=xaxis;u_yaxis=yaxis	u_dx=dx;u_dy=dy	u_orient=orient;u_label=label		FCalibrator(xaxis,yaxis,dx,dy,orient,label)End// Replace "Function" with "Macro" to reduce compile timeFunction FCalibrator(xaxis,yaxis,dx,dy,orient,label)	String xaxis,yaxis	Variable/D dx,dy	Variable orient,label	// see popup list of Calibrator macro for label values (1 is don't print, etc)		// Put calibrator in upper right corner of graph	Variable/D xorig,yorig	// corner of calibrator	Variable/D px,py		// polygon origin	Variable/D hx,hy,vx,vy	// text origins	Variable/D sf=0.15		// inset from upper-right corner	GetAxis/Q $xaxis;xorig=V_max-(V_max-V_min)*sf	GetAxis/Q $yaxis;yorig=V_max-(V_max-V_min)*sf	GraphNormal			// Forces deselection	SetDrawEnv gstart		// gstart can't be on next line!	SetDrawEnv xcoord= $xaxis,ycoord= $yaxis, fillpat=0,linethick=2, linefgc=(0,0,0)	if(orient == 1) // upper-left		xorig -= dx		hx= xorig + dx/2		vy= yorig - dy/2		px= xorig;py=yorig-dy		DrawPoly px,py, 1, 1, {0,0,0,dy,dx,dy}	endif	if(orient == 2) // upper-right		hx= xorig - dx/2		vy= yorig - dy/2		px= xorig-dx;py=yorig		DrawPoly px,py, 1, 1, {0,0,dx,0,dx,-dy}	endif	if(orient == 3) // lower-right		yorig -= dy		hx= xorig - dx/2		vy= yorig + dy/2		px= xorig;py=yorig+dy		DrawPoly px,py, 1, 1, {0,0,0,-dy,-dx,-dy}	endif	if(orient == 4) // lower left		xorig -= dx		yorig -= dy		hx= xorig + dx/2		vy= yorig + dy/2		px= xorig+dx;py=yorig		DrawPoly px,py, 1, 1, {0,0,-dx,0,-dx,dy}	endif	String labelVal,fmt,units	// horizontal calibrator value	if( (dx != 0)%& (label>1) )		// label == 1 is don't print		units= AxisUnits(xaxis)		fmt="%g"		if( (label== 3) %& (strlen(units)>0) )	// 3 is print with units			fmt += " "+units		endif		if(label == 4)				// 4 is print with units and prefixes			fmt="%.1W1P"+units	// change %.1 to number of digits after decimal point you want (%.2 is two digits, etc)		endif		sprintf labelVal, fmt, dx		hy = yorig-(0.1*dy)		Variable yj=0	// bottom		if( orient >= 3 )			yj= 2		// top		endif		SetDrawEnv xcoord= $xaxis,ycoord= $yaxis,textxjust=1,textyjust=yj		DrawText hx,hy, labelVal	endif	// vertical calibrator value	if( (dy != 0)%& (label>1) )		units= AxisUnits(yaxis)		fmt="%g"		if( (label== 3) %& (strlen(units)>0) )			fmt += " "+units		endif		if(label == 4)			fmt="%.1W1P"+units		endif		sprintf labelVal, fmt, dy		vx= xorig+(0.1*dx)		Variable xj=0,rot=0					// left	| use rot= -90 for top-to-bottom		if( (orient == 1) %| (orient == 4) )	// "upper-left; upper-right;lower-right;lower left;"			xj= 0								// right use rot=90 for bottom-to-top		endif		SetDrawEnv xcoord= $xaxis,ycoord= $yaxis,textxjust= xj,textyjust=1,textrot=rot		DrawText vx,vy, " "+labelVal+" "	// extra spaces to keep label away from line	endif	SetDrawEnv gstopEndFunction CountItemsInList(theList)        String theList        Variable i=0        do                if (strlen(GetStrFromList(theList, i, ";")) == 0)                        break                endif                i += 1        while(1)        return iendFunction CountWaves(BaseStr)       String BaseStr 	return CountItemsInList(GetSweepList(BaseStr))endFunction /S GetSweepList(BaseStr)	String BaseStr	String SweepList	String firstList, item, back       Variable xx, i	firstList = WaveList(BaseStr+"*", ";","")//	removes all items from the list that do not have the form BaseStr+number      SweepList = ""      i =0      	do       	item = GetStrFromList(firstList, i, ";")		if (strlen(item) == 0)                        break              else			xx = str2num(item[strlen(BaseStr),99])			back = BaseStr+num2str(xx)			if (abs(cmpstr(item,back))<1)				SweepList += item+";"			endif		endif		i += 1	while(1)	return SweepListEndFunction SetStepVarProc(ctrlName,varNum,varStr,varName) : SetVariableControl	String ctrlName	Variable varNum	String varStr	String varName	String command	NVAR iCurrentSweep=iCurrentSweep	sprintf command, "SetStepValue(\"%s\",%d,%d)", varName, iCurrentSweep, varNum	Execute commandEndProc SetStepValue(whichstep, whichsweep, stepval)	String whichstep	Variable whichsweep, stepval	String wavestr	if (cmpstr(whichstep,"step1")<1)		sprintf wavestr, "%s%d", baseName1, whichsweep		WriteWaveNote($wavestr,"STEP",num2str(stepval))	endif	if (cmpstr(whichstep,"step2")<1)		sprintf wavestr, "%s%d", baseName2, whichsweep		WriteWaveNote($wavestr,"STEP",num2str(stepval))	endif	if (cmpstr(whichstep,"step3")<1)		sprintf wavestr, "%s%d", baseName1, whichsweep		WriteWaveNote($wavestr,"STEP",num2str(stepval))		sprintf wavestr, "%s%d", baseName2, whichsweep		WriteWaveNote($wavestr,"STEP",num2str(stepval))	endifEnd